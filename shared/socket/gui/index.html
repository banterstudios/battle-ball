<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">
		<title>Name is Jeff lol</title>
		<meta name="description" content="Banterstudios - HTML5 Game">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><style type="text/css"></style>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/1.0.5/jquery.hammer.min.js"></script>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script type="text/javascript" src="../scripts/qrcode.min.js"></script>
		<script type="text/javascript" src="../scripts/socket.io-1.3.7.js"></script>
		<link rel="stylesheet" href="santa.css" type="text/css"></link>
		<script src="santa.js"></script>
	</head>
	<body>
		<div id="santa-gui">
			<div class="title"></div>
			<div class="tv">
				<div class="canvas">
					<audio preload="true" id="bazooka">
						<source src="game/assets/sounds/bazooka.mp3">
						<source src="game/assets/sounds/bazooka.ogg">
						<source src="game/assets/sounds/bazooka.wav">
					</audio>
					<audio preload="true" id="gun">
						<source src="game/assets/sounds/gun.mp3">
						<source src="game/assets/sounds/gun.ogg">
						<source src="game/assets/sounds/gun.wav">
					</audio>
					<audio preload="true" id="jump">
						<source src="game/assets/sounds/Jump.mp3">
						<source src="game/assets/sounds/Jump.ogg">
						<source src="game/assets/sounds/Jump.wav">
					</audio>
					<audio preload="true" id="bg" loop="">
						<source src="game/assets/sounds/jinglebells.mp3">
						<source src="game/assets/sounds/jinglebells.ogg">
						<source src="game/assets/sounds/jinglebells.wav">
					</audio>
					<audio preload="true" id="menunavigate">
						<source src="game/assets/sounds/menunavigate.mp3">
						<source src="game/assets/sounds/menunavigate.ogg">
						<source src="game/assets/sounds/menunavigate.wav">
					</audio>
					<audio preload="true" id="select">
						<source src="game/assets/sounds/select.mp3">
						<source src="game/assets/sounds/select.ogg">
						<source src="game/assets/sounds/select.wav">
					</audio>
					<audio preload="true" id="explosion">
						<source src="game/assets/sounds/explosion.mp3">
						<source src="game/assets/sounds/explosion.ogg">
						<source src="game/assets/sounds/explosion.wav">
					</audio>					
					<canvas id="game" width="480" height="240" style="height: 647.5px;"></canvas> 
					<article class="overlays" style="transform: scale(2.7); margin: 0px;">
						<section class="mobile">
							<div class="overlayassets jump mobileaction"></div>
							<div class="overlayassets start mobileaction"></div>
							<div class="overlayassets b mobileaction"></div>
							<div class="overlayassets a mobileaction"></div>
						</section>
					</article>
					<article class="menu active" style="transform: scale(2.7); margin: 0px;">
						<section class="menu-container">
							<section class="home active">
								<div class="play text">Play</div>
								<div class="leaderboards text">Leaderboards</div>
								<div class="about text">About</div>
								<div class="settings text">Settings</div>
								<div class="logout text">Logout</div>
							</section>

							<section class="ingame-pause">
								<div class="resume text">Resume</div>
								<div class="settings text">Settings</div>
								<div class="restart text">Restart</div>
								<div class="quit text">Quit</div>
								<section class="social-icons">
									<img class="social-icon twitter" src="game/assets/menu/twitter.png">
									<img class="social-icon facebook" src="game/assets/menu/facebook.png">
									<img class="social-icon linkedin" src="game/assets/menu/linkedin.png">
								</section>
							</section>

							<section class="settings">
								<div class="audio text">Audio</div>
								<div class="music text">Music</div>
								<div class="back"></div>
							</section>

							<section class="leaderboards">
								<div class="personalscore title uppercase">personal best</div>
								<ul class="score-list">
									<!-- <li>1_ 1,000 Nick</li> -->
								</ul>
								<div class="play text">Play</div>
								<section class="social-icons">
									<img class="social-icon twitter" src="game/assets/menu/twitter.png">
									<img class="social-icon facebook" src="game/assets/menu/facebook.png">
									<img class="social-icon linkedin" src="game/assets/menu/linkedin.png">
								</section>
								<div class="back"></div>
							</section>

							<section class="about">
								<div class="about-us text paragraph">
									Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
									Cras tempor, felis vitae pulvinar malesuada, augue sapien fermentum quam, quis finibus massa ex eu sem. 
								</div>
								<a class="text link" href="http://www.vitaminlondon.com" target="_blank">www.vitaminlondon.com</a>
								<section class="social-icons">
									<img class="social-icon twitter" src="game/assets/menu/twitter.png">
									<img class="social-icon facebook" src="game/assets/menu/facebook.png">
									<img class="social-icon linkedin" src="game/assets/menu/linkedin.png">
								</section>
								<div class="back"></div>
							</section>

							<section class="login">
								<input class="login-email" type="email" placeholder="email">
								<input class="login-password" type="password" placeholder="password" style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QsPDiEFu6xIcAAAAXhJREFUOMvNk8FLVFEUxn/ffRdmIAla1CbBFDGCpoiQWYlBLty7UHAvEq2HYLhveDMws2/TIly6E9SdIEj+AVYgRaTgXhe2C968x2nhTOjow8pNZ/ede/ide893Lvx3UavVhkMIk30dQqiGECpF9e68CCG8LpfL3yStAAIk6Z2kT3Ect68C+AGdSroFVEII82aWSXoGYGYHVwE0qOM43pU0BXw3s1zSI2AnSZKXhYB6vT7inLvd7XZ/eu8fOOe2JEW9zjkwZ2bHkoayLDtpt9ufLzzBe/8GWC6VSpc7nIE2pLPLeu/fA0uDQ3T/6pp6039uZnfN7Ieke1EUrQOu3/VawPloNBrbwIyZ7TvnLvg/+mKOJ3xk88NR4R4sADM92fp9MDRMdXaRxenHVMbuFy8SMAFkZval2Wyu9ZN3Hk4zWx0nAtKsWwxotVrNNE2f5nn+CrB+/nRvlSR5y2EK0TWbSKfT+fo3Lribfr4bA/yfl56y2kkuZX8BjXVyqMs8oFcAAAAASUVORK5CYII=); background-attachment: scroll; background-position: 100% 50%; background-repeat: no-repeat;" autocomplete="off">
								<div class="start text">Login</div>
								<div class="register text">Register</div>
							</section>

							<section class="register">
								<input class="register-email" type="email" placeholder="email">
								<input class="register-nickname" type="text" placeholder="St nickname">
								<input class="register-password" type="password" placeholder="password" style="background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QsPDiEFu6xIcAAAAXhJREFUOMvNk8FLVFEUxn/ffRdmIAla1CbBFDGCpoiQWYlBLty7UHAvEq2HYLhveDMws2/TIly6E9SdIEj+AVYgRaTgXhe2C968x2nhTOjow8pNZ/ede/ide893Lvx3UavVhkMIk30dQqiGECpF9e68CCG8LpfL3yStAAIk6Z2kT3Ect68C+AGdSroFVEII82aWSXoGYGYHVwE0qOM43pU0BXw3s1zSI2AnSZKXhYB6vT7inLvd7XZ/eu8fOOe2JEW9zjkwZ2bHkoayLDtpt9ufLzzBe/8GWC6VSpc7nIE2pLPLeu/fA0uDQ3T/6pp6039uZnfN7Ieke1EUrQOu3/VawPloNBrbwIyZ7TvnLvg/+mKOJ3xk88NR4R4sADM92fp9MDRMdXaRxenHVMbuFy8SMAFkZval2Wyu9ZN3Hk4zWx0nAtKsWwxotVrNNE2f5nn+CrB+/nRvlSR5y2EK0TWbSKfT+fo3Lribfr4bA/yfl56y2kkuZX8BjXVyqMs8oFcAAAAASUVORK5CYII=); background-attachment: scroll; background-position: 100% 50%; background-repeat: no-repeat;" autocomplete="off">
								<div class="agreeandstart text">Register</div>
								<div class="back"></div>
							</section>
						</section>
					</article>			  
					<script>
						var debug = !1;
						var music = !1;
						var sfx = !1;
						var leftkey = !1;
						var rightkey = !1;
						var upkey = !1;
						var downkey = !1;

						var canvas = document.getElementsByTagName('canvas')[0],
							ctx = canvas.getContext('2d');

						var oCanvas = document.createElement('canvas');
						var oCtx = oCanvas.getContext('2d');
						oCanvas.width = 480;
						oCanvas.height = 240;



						var w = window;
						var requestAnimationFrame = w.requestAnimationFrame || w.webkitRequestAnimationFrame || w.msRequestAnimationFrame || w.mozRequestAnimationFrame;
						var cancelAnimationFrame = w.cancelAnimationFrame || w.webkitCancelRequestAnimationFrame || w.msCancelRequestAnimationFrame || w.mozCancelRequestAnimationFrame || clearTimeout;

						var playWidth = canvas.width;
						var playHeight = canvas.height;
						var scrollWidth = 0;
						var scrollHeight = 0;

						var isMobile = function ()
						{
						  return /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0, 4))
						}

						var mouse = {
						  x:0,
						  y:0,
						  w:10,
						  h:10,
						  sx:0,
						  sy:0
						};

						/*
						==================
						HELPER FUNCTIONS
						==================
						*/

						function Vector(x,y){
							this.x = x || 0;
							this.y = y || 0;
						};

						var pattern = function(_bg){
							var ptrn = ctx.createPattern(_bg, 'repeat'); // Create a pattern with this image, and set it to "repeat".
						    ctx.fillStyle = ptrn;
						    ctx.fillRect(0, 0, playWidth, playHeight); // ctx.fillRect(x, y, width, height);
						};

						var debug_console = {
							warn:function(_e){console.warn(_e);},
							log:function(_e){console.log(_e);}
						}

						function getBase64Image(img) {
						    var _canvas = document.createElement("canvas");
						    _canvas.width = img.width;
						    _canvas.height = img.height;

						    var _ctx = _canvas.getContext("2d");
						    _ctx.drawImage(img, 0, 0);

						    var dataURL = _canvas.toDataURL("image/png");

						    return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
						}

						function loadSprites(src,callback){
							var sprite = new Image();
						    sprite.src = src;
						    sprite.onload = function(){callback(sprite);}
						};

						function getOffsetX(x){
						 
						  var rect = canvas.getBoundingClientRect();
						  return x-rect.left;
						 // return x-$('canvas').offset().left;
						};
						function getOffsetY(y){
						  var rect = canvas.getBoundingClientRect();
						  return y-rect.top;
						  //return y-$('canvas').offset().top;
						};

						/*
						==========
						COLLISION
						==========
						*/
						var getCenterDifference=function(a,b){

						    var x = a.x - b.x;
						    var y = a.y - b.y;

						    return ({x:Math.abs(x),y:Math.abs(y)});

						};



						var boundingBoxCollision = function(a, b, _cp) {
						//if tile
						/*
						    tile.collision if collision is false then its not a collidable object so continue
						    tile.inView  if inview is false then continue, no point doing collision if its not in the view. 
						*/

						  if(a.dead || b.dead || a.layer===b.layer || !a.collision || !b.collision || a.type==='Deer'&&b.type==='Player' || a.type==='Deer'&&b.type==='Deer' || a.type==='Elf'&&b.type==='Player' || a.type==='Elf'&&b.type==='Elf' || a.type==='Elf'&&b.type==='Deer' || a.type==='Deer'&&b.type==='Elf')return false;


						  if((Math.abs(_cp.x - b.position.x) * 2 < (a.bbox.x + b.bbox.x)) &&
						         (Math.abs(_cp.y - b.position.y) * 2 < (a.bbox.y + b.bbox.y))){


						      if(b.platform){ // if a platform object
						        if((a.position.y+a.bbox.y)<= b.position.y){return true;}
						        return false;
						      };

						       switch(_cp.side){
						        case Character.DIRECTIONS.UP:
						         if (_cp.y > (b.position.y+b.bbox.y) && _cp.y < b.position.y){
						            return true;
						          }
						        break;

						        case Character.DIRECTIONS.DOWN:
						          if((_cp.y+a.bbox.y) > b.position.y && _cp.y < b.position.y){
						            return true;
						          }
						        break;

						        case Character.DIRECTIONS.LEFT:
						         if(_cp.x < (b.position.x+b.bbox.x) && (_cp.x+a.bbox.x) > (b.position.x+b.bbox.x)){
						            return true;
						          }
						        break;

						        case Character.DIRECTIONS.RIGHT:
						           if((_cp.x+a.bbox.x) > b.position.x && _cp.x < b.position.x){
						            return true;
						          }
						        break;
						      }
						  
						     /* var aCenter = {
						        x:((_cp.x)+(a.bbox.x/2)),
						        y:((_cp.y)+(a.bbox.y/2))
						      };
						      var bCenter = {
						        x:((b.position.x)+(b.bbox.x/2)),
						        y:((b.position.y)+(b.bbox.y/2))
						      };

						        var difference = getCenterDifference(bCenter,aCenter);//objectBCenter - objectACenter;
						        if(difference.x > difference.y && difference.x > 0) { if(_cp.side===Character.DIRECTIONS.RIGHT){return true;}  } //right
						        if(difference.x > difference.y && difference.x < 0) { if(_cp.side===Character.DIRECTIONS.LEFT){return true;}  } //left
						        if(difference.x < difference.y && difference.y > 0) { if(_cp.side===Character.DIRECTIONS.DOWN){return true;}  } //down
						        if(difference.x < difference.y && difference.y < 0) { if(_cp.side===Character.DIRECTIONS.UP){return true;}  } //up*/

						        return false;
						    }

						    return false;

						};

						var slopeCollision=function(ax,ay,bx,by,prr){
							for(var l=prr.length,i=0,s,t;i<l;i++){
								t=((prr[i][0]-ax)*(by-ay)/(bx-ax)+ay-prr[i][1]);
							if(!t) return !0; t=t>0?1:-1; if(i&&t!=s) return !0; s=t;
							}return !1;
						};

						/*
						if(slopeCollision(slopes[i].slopeline1.x,slopes[i].slopeline1.y,slopes[i].slopeline2.x,slopes[i].slopeline2.y,
							[[playerline1.x,playerline1.y],[playerline2.x,playerline2.y],[playerline3.x,playerline3.y],[playerline4.x,playerline4.y]])){
							self.finished = true;
						 	return true;
						}
						*/

						function rotate(x, y, xm, ym, a) {
						    var cos = Math.cos,
						        sin = Math.sin,

						        a = a * Math.PI / 180, // Convert to radians because that is what
						                               // JavaScript likes

						        // Subtract midpoints, so that midpoint is translated to origin
						        // and add it in the end again
						        xr = (x - xm) * Math.cos(a) - (y - ym) * Math.sin(a)   + xm,
						        yr = (x - xm) * Math.sin(a) + (y - ym) * Math.cos(a)   + ym;

						    return {x:xr, y:yr};
						}

						function toggleFullScreen() {
						  var doc = window.document;
						  var docEl = doc.documentElement;

						  var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
						  var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

						  if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
						    requestFullScreen.call(docEl);
						  }
						  else {
						   // cancelFullScreen.call(doc);
						  }
						}


						function compare(a,b) {
						  if (a.x < b.x)
						    return -1;
						  if (a.x > b.x)
						    return 1;
						  return 0;
						}

						var prefix = (function () {
						  var styles = window.getComputedStyle(document.documentElement, ''),
						    pre = (Array.prototype.slice
						      .call(styles)
						      .join('') 
						      .match(/-(moz|webkit|ms)-/) || (styles.OLink === '' && ['', 'o'])
						    )[1],
						    dom = ('WebKit|Moz|MS|O').match(new RegExp('(' + pre + ')', 'i'))[1];
						  return {
						    dom: dom,
						    lowercase: pre,
						    css: '-' + pre + '-',
						    js: pre[0].toUpperCase() + pre.substr(1)
						  };
						})();


						/*
						VALIDATIONS
						*/
						function validateEmail(email) {
						  if(email === '')return false;
						    var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
						    return re.test(email);
						};

						function validatePassword(password){
						  if(password === '')return false;
						  var re = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}/;
						    return re.test(password);

						    /*
						    matches a string of six or more characters;
						    that contains at least one digit (\d is shorthand for [0-9]);
						    at least one lowercase character; and
						    at least one uppercase character:
						  */
						};

						function validateName(name){
						  if(name === '')return false;
						  if(name.length < 2)return false;
						  if(name.length >= 20)return false;
						  return true;
						};




						function ProjectileEquation(_opts) {  
						    
						    this.startVelocity = new Vector(_opts.vx, _opts.vy);  
						    this.startPoint = new Vector(_opts.x, _opts.y);  
						};

						ProjectileEquation.prototype.getX=function(t){  
						  return this.startVelocity.x * t + this.startPoint.x;  
						}; 
						  
						ProjectileEquation.prototype.getY=function(t){
						  return 0.5 * Character.gravity * t * t + this.startVelocity.y * t + this.startPoint.y;  
						};    









						/*function BallisticVel(transform, target, angle){

						  var x = transform.velocity.x + Math.
						  return { x: };
						};*/


						/*function BallisticVel(transform, target, angle) { 
						  var dir = getDistance(target, transform); 
						  var h = dir.y; 
						  dir.y = 0; 
						  var dist = Math.sqrt(dir.x*dir.x + dir.y*dir.y);//    dir.magnitude; 

						  console.log('DIST: ' + dist);

						  var a = angle; // * (Math.PI/180);

						  console.log('ANGLE: ' + a);

						  dir.y = dist * Math.tan(a);

						  console.log('DIR Y: ' + dir.y);

						  dist += h / Math.tan(a); 

						  console.log('DIST: ' + dist);

						  var vel = Math.sqrt((dist * Character.gravity) / Math.sin(2 * a)); 

						  console.log('VEL: ' + vel);

						  return (getVelocity(vel, dir,dist)); 
						} //returns a vector


						function getDistance(target, transform){
						  var obj = {};
						  obj.x = target.x - transform.position.x;
						  obj.y = target.y - transform.position.y;

						  return obj;
						};

						function getVelocity(vel, dir,dist){
						  var objn = normalize(dir,dist);
						  return {x: objn.x*vel, y:objn.y*vel};
						};
						function normalize(obj,dist){
						  return {x: obj.x / dist, y:obj.y/dist }; 
						};
						*/

						function normalize(obj,dist){
						  return {x: obj.x / dist, y:obj.y/dist }; 
						};

						;
								GAME_HANDLER = {
							API:'http://christmas.vitaminlondon.com/api15',
							REGISTER:'/register.php',
							LOGIN:'/login.php',
							LOGOUT:'/logout.php',
							SUBMIT:'/submit.php',
							GETSCORE:'/read_scores.php',
							FORGOTPASSWORD:'/forgot.php',
							SETPASS:'/pass_setup.php',
							CALL:{
								GET:function(params, callback){
								    $.ajax({
								      url:GAME_HANDLER.API + params.url,
								      method: "GET",
								      dataType: "json",
								      success: function(response){
								       
								        try{
								          var obj;

								          if(typeof(response)==='object'){
								            obj = response;
								          }else{
								            response = JSON.stringify(response);
								            obj = JSON.parse(response);
								          }
								          callback({d:'success', response:obj});
								        }catch(e){
								          console.log('FAILED: ' + e);
								        }
								      },
								      complete:function(response){
								      	
								      },
								      error: function(xhr, statusText , err) {
								        if(xhr.status >= 400){
								          callback({d:'error', response:xhr.responseText});
								          console.log('GENERIC ERROR: ' + xhr.status + ' ' + statusText + ' ' + err + ' ' + xhr.responseText );
								          return;
								        }
								        callback({d:'genericerror', response:xhr.responseText});
								        console.log('GENERIC ERROR: ' + xhr.status + ' ' + statusText + ' ' + err + ' ' + xhr.responseText );
								      }
								    });
								},
								POST:function(params, callback){
								    $.ajax({
								      url:GAME_HANDLER.API + params.url,
								      method: "POST",
								      dataType: "json",
								      data:JSON.stringify(params.data),
								      success: function(response){
								        try{
								          var obj;

								          if(typeof(response)==='object'){
								            obj = response;
								          }else{
								            response = JSON.stringify(response);
								            obj = JSON.parse(response);
								          }
								     
								          callback({d:'success', response:obj});
								        }catch(e){
								          console.log('FAILED: ' + e);
								        }
								      },
								      complete:function(response){
								      },
								      error: function(xhr, statusText , err) { 
								      	
								        if(xhr.status >= 400){
								          callback({d:'error', response:xhr.responseText});
								          console.log('GENERIC ERROR: ' + xhr.status + ' ' + statusText + ' ' + err + ' ' + xhr.responseText );
								          return;
								        }
								        callback({d:'genericerror', response:xhr.responseText});
								        console.log('GENERIC ERROR: ' + xhr.status + ' ' + statusText + ' ' + err + ' ' + xhr.responseText );
								      }
								    }); 
								}
							}
						};


						GAME_HANDLER.Login=function(){

							if(!validateEmail($('.login-email').val())){ console.log('invalid email'); return false; }
							if(!validatePassword($('.login-password').val())){ console.log('invalid password'); return false; }
							var data = {'email':$('.login-email').val(), 'passwd':$('.login-password').val()};
							GAME_HANDLER.CALL.POST({url:GAME_HANDLER.LOGIN, data:data}, function(e){
						 		if(typeof(e.response) !== 'undefined'){
									if(typeof(e.response.type) !== 'undefined'){
										if(e.response.type === 'ErrorException'){
											GAME_HANDLER.Logout();
											console.log('ErrorException');
											return;
										}

										if(e.response.type === 'Exception'){
											if(e.response.d === 'no_session'){
												GAME_HANDLER.Logout();
												console.log('no session');
												return;
											}
										}
									}
								};

								if(e.d === 'success'){
									if(window.localStorage){ window.localStorage.setItem('token',e.response); console.log('set the token!'); }
									if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['home']); return; }
									g_Menus['home'].On();
									console.log('successfully logged in!');
									return;
								};

								//logout

								console.log('unknown problem atm!');

							});
						};

						GAME_HANDLER.Register=function(){
							if(!validateEmail($('.register-email').val())){ console.log('invalid email'); return false; }
							if(!validatePassword($('.register-password').val())){ console.log('invalid password'); return false; }
							if(!validateName($('.register-nickname').val())){ console.log('invalid nickname'); return false; }
							

							var data = {'uname':$('.register-nickname').val(),'email':$('.register-email').val(), 'passwd':$('.register-password').val()};
							GAME_HANDLER.CALL.POST({url:GAME_HANDLER.REGISTER, data:data}, function(e){
						 		if(typeof(e.response) !== 'undefined'){
									if(typeof(e.response.type) !== 'undefined'){
										if(e.response.type === 'ErrorException'){
											GAME_HANDLER.Logout();
											console.log('ErrorException');
											return;
										}

										if(e.response.type === 'Exception'){
											if(e.response.d === 'no_session'){
												GAME_HANDLER.Logout();
												console.log('no session');
												return;
											}
										}
									}
								};

								if(e.d === 'success'){
									console.log('successfully registered!');
									$('.login-email').val($('.register-email').val());
									if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['login']); return; }
									g_Menus['login'].On();
									return;
								};

								//logout

								console.log('unknown problem atm!');

							});
						};

						GAME_HANDLER.Logout=function(){
							
							if(!window.localStorage || !window.localStorage.getItem('token')){console.log('no token!'); return false; }

							var data = {'sess':window.localStorage.getItem('token')};

							GAME_HANDLER.CALL.POST({url:GAME_HANDLER.LOGOUT, data:data}, function(e){
						 		if(typeof(e.response) !== 'undefined'){
									if(typeof(e.response.type) !== 'undefined'){
										if(e.response.type === 'ErrorException'){
											//logout
											console.log('ErrorException');
											return;
										}

										if(e.response.type === 'Exception'){
											if(e.response.d === 'no_session'){
												//logout
												console.log('no session');
												return;
											}
										}
									}
								};

								if(e.d === 'success'){
									console.log('successfully Logged out!');
									window.localStorage.removeItem('token');
									if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['login']); return; }
									g_Menus['login'].On();
									return;
								};

								//logout

								console.log('unknown problem atm!');

							});
						};


						GAME_HANDLER.GetScore=function(){
							
							if(!window.localStorage || !window.localStorage.getItem('token')){console.log('no token!'); return false; }

							var data = {'sess':window.localStorage.getItem('token')};

							GAME_HANDLER.CALL.POST({url:GAME_HANDLER.GETSCORE, data:data}, function(e){
						 		if(typeof(e.response) !== 'undefined'){
									if(typeof(e.response.type) !== 'undefined'){
										if(e.response.type === 'ErrorException'){
											//logout
											GAME_HANDLER.Logout();
											console.log('ErrorException');
											return;
										}

										if(e.response.type === 'Exception'){
											if(e.response.d === 'no_session'){
												GAME_HANDLER.Logout();
												console.log('no session');
												return;
											}
										}
									}
								};

								if(e.d === 'success'){
									console.log('successfully got scores!');
									$('.score-list > li').remove();
									if(e.response.length <= 1){console.log('no scores saved'); return; }

									console.log(e.response);
									
									e.response.shift();

									e.response.sort(function(a, b) {
									    return a[1] - b[1];
									});

									e.response.reverse();

									var li = '';
									for(var i=0,len=e.response.length; i<len; i++){
										li = '<li>' + i + '_ ' + e.response[i][1] + ' ' + e.response[i][0] + '</li>';
										$('.score-list').append($(li));
									};

									return;
								};

								//logout

								console.log('unknown problem atm!');

							});
						};

						GAME_HANDLER.PostScore=function(){
							if(!g_Player || !g_Player.distance){console.log('THERE IS NO PLAyER! OR DISTANCE IS 0');}
							if(!window.localStorage || !window.localStorage.getItem('token')){console.log('no token!'); return false; }

							var data = {'sess':window.localStorage.getItem('token'), 'score':g_Player.distance};

							GAME_HANDLER.CALL.POST({url:GAME_HANDLER.SUBMIT, data:data}, function(e){
						 		if(typeof(e.response) !== 'undefined'){
									if(typeof(e.response.type) !== 'undefined'){
										if(e.response.type === 'ErrorException'){
											//logout
											console.log('ErrorException');
											return;
										}

										if(e.response.type === 'Exception'){
											if(e.response.d === 'no_session'){
												//logout
												console.log('no session');
												return;
											}
										}
									}
								};

								if(e.d === 'success'){
									console.log(e.response);
									return;
								};

								//logout

								console.log('unknown problem atm!');

							});
						};


						;
								 /*
							  * QuadTree Constructor
							  * @param Object bounds		bounds of the node, object with x, y, width, height
							  * @param Integer max_objects		(optional) max objects a node can hold before splitting into 4 subnodes (default: 10)
							  * @param Integer max_levels		(optional) total max levels inside root QuadTree (default: 4) 
							  * @param Integer level		(optional) deepth level, required for subnodes  
							  */
							function QuadTree( bounds, max_objects, max_levels, level ) {
								
								this.max_objects	= max_objects || 10;
								this.max_levels		= max_levels || 4;
								
								this.level 		= level || 0;
								this.bounds 		= bounds;
								
								this.objects 		= [];
								this.nodes 		= [];
							};
							
							
							/*
							 * Split the node into 4 subnodes
							 */
							QuadTree.prototype.split = function() {
								
								var nextLevel	= this.level + 1,
									subWidth	= Math.round( this.bounds.width / 2 ),
									subHeight 	= Math.round( this.bounds.height / 2 ),
									x 		= Math.round( this.bounds.x ),
									y 		= Math.round( this.bounds.y );		
							 
							 	//top right node
								this.nodes[0] = new QuadTree({
									x	: x + subWidth, 
									y	: y, 
									width	: subWidth, 
									height	: subHeight
								}, this.max_objects, this.max_levels, nextLevel);
								
								//top left node
								this.nodes[1] = new QuadTree({
									x	: x, 
									y	: y, 
									width	: subWidth, 
									height	: subHeight
								}, this.max_objects, this.max_levels, nextLevel);
								
								//bottom left node
								this.nodes[2] = new QuadTree({
									x	: x, 
									y	: y + subHeight, 
									width	: subWidth, 
									height	: subHeight
								}, this.max_objects, this.max_levels, nextLevel);
								
								//bottom right node
								this.nodes[3] = new QuadTree({
									x	: x + subWidth, 
									y	: y + subHeight, 
									width	: subWidth, 
									height	: subHeight
								}, this.max_objects, this.max_levels, nextLevel);
							};
							
							
							/*
							 * Determine which node the object belongs to
							 * @param Object pRect		bounds of the area to be checked, with x, y, width, height
							 * @return Integer		index of the subnode (0-3), or -1 if pRect cannot completely fit within a subnode and is part of the parent node
							 */
							QuadTree.prototype.getIndex = function( pRect ) {
								
								var 	index 			= -1,
									verticalMidpoint 	= this.bounds.x + (this.bounds.width / 2),
									horizontalMidpoint 	= this.bounds.y + (this.bounds.height / 2),
							 
									//pRect can completely fit within the top quadrants
									topQuadrant = (pRect.position.y < horizontalMidpoint && pRect.position.y + pRect.size.y < horizontalMidpoint),
									
									//pRect can completely fit within the bottom quadrants
									bottomQuadrant = (pRect.position.y > horizontalMidpoint);
								 
								//pRect can completely fit within the left quadrants
								if( pRect.position.x < verticalMidpoint && pRect.position.x + pRect.size.x < verticalMidpoint ) {
									if( topQuadrant ) {
										index = 1;
									} else if( bottomQuadrant ) {
										index = 2;
									}
									
								//pRect can completely fit within the right quadrants	
								} else if( pRect.position.x > verticalMidpoint ) {
									if( topQuadrant ) {
										index = 0;
									} else if( bottomQuadrant ) {
										index = 3;
									}
								}
							 
								return index;
							};
							
							
							/*
							 * Insert the object into the node. If the node
							 * exceeds the capacity, it will split and add all
							 * objects to their corresponding subnodes.
							 * @param Object pRect		bounds of the object to be added, with x, y, width, height
							 */
							QuadTree.prototype.insert = function( pRect ) {
								
								var 	i = 0,
							 		index;
							 	
							 	//if we have subnodes ...
								if( typeof this.nodes[0] !== 'undefined' ) {
									index = this.getIndex( pRect );
							 
								  	if( index !== -1 ) {
										this.nodes[index].insert( pRect );	 
									 	return;
									}
								}
							 	
							 	this.objects.push( pRect );
								
								if( this.objects.length > this.max_objects && this.level < this.max_levels ) {
									
									//split if we don't already have subnodes
									if( typeof this.nodes[0] === 'undefined' ) {
										this.split();
									}
									
									//add all objects to there corresponding subnodes
									while( i < this.objects.length ) {
										
										index = this.getIndex( this.objects[ i ] );
										
										if( index !== -1 ) {					
											this.nodes[index].insert( this.objects.splice(i, 1)[0] );
										} else {
											i = i + 1;
									 	}
								 	}
								}
							 };
							 
							 
							/*
							 * Return all objects that could collide with the given object
							 * @param Object pRect		bounds of the object to be checked, with x, y, width, height
							 * @Return Array		array with all detected objects
							 */

							QuadTree.prototype.retrieve = function( pRect ) {
							 	
								var 	index = this.getIndex( pRect ),
									returnObjects = this.objects;
									
								//if we have subnodes ...
								if( typeof this.nodes[0] !== 'undefined' ) {
									
									//if pRect fits into a subnode ..
									if( index !== -1 ) {
										returnObjects = returnObjects.concat( this.nodes[index].retrieve( pRect ) );
										
									//if pRect does not fit into a subnode, check it against all subnodes
									} else {
										for( var i=0; i < this.nodes.length; i=i+1 ) {
											returnObjects = returnObjects.concat( this.nodes[i].retrieve( pRect ) );
										}
									}
								}
							 	

								return returnObjects;
							};
							
							
							/*
							 * Clear the quadtree
							 */
							QuadTree.prototype.clear = function() {
								
								this.objects = [];
							 
								for( var i=0; i < this.nodes.length; i=i+1 ) {
									if( typeof this.nodes[i] !== 'undefined' ) {
										this.nodes[i].clear();
								  	}
								}

								this.nodes = [];
							};

							/*
							UPDATE TREE
							*/
							QuadTree.prototype.Update=function(){
								this.bounds.x = g_Level.viewport.x;
								this.clear();
								for(var i = 0, len = g_Level.levels[g_Level.currentLevel].collisionChildren.length; i < len; i++)this.insert( g_Level.levels[g_Level.currentLevel].collisionChildren[i] );
							};
								var settings = {

							aboutusText:'Lorem ipsum dolor sit amet'
						};;
								//MENUS

						function Menu(_opts){
							this.buttons = _opts&&_opts.buttons || [];
							this.position = new Vector( _opts&&_opts.x || 0, _opts&&_opts.y || 0 );
							this.dest = new Vector( _opts&&_opts.dx || 0, _opts&&_opts.dy || 0 );
							this.size = new Vector( _opts&&_opts.w || 32, _opts&&_opts.h || 32 );
							this.color = _opts&&_opts.color || '#333333';
							this.active = _opts&&_opts.active || false;
							this.maxWidth = 384;
							this.maxHeight = 168;
							this.scrollDimensions = new Vector(_opts&&_opts.scrollX || 0, _opts&&_opts.scrollY || 0);
							this.hasScroll = _opts&&_opts.hasScroll || false;
							this.scrollTop  = 0;
							this.scrollBottom = 0;
							this.listItems = [];

						};
						Menu.prototype.Initialise = function() {
							for(var i = 0, len = this.buttons.length; i < len; i++){this.buttons[i].Initialise(this)}
						};
						Menu.prototype.Update = function(delta) {
							if(!this.active || !Arena.spriteSheets['menu'].img || !Arena.spriteSheets['menu'].spritesLoaded)return false;
						};
						Menu.prototype.Render = function() {
							if(!this.active || !Arena.spriteSheets['menu'].img || !Arena.spriteSheets['menu'].spritesLoaded)return false;

							//render image! but for now just a rect
							ctx.drawImage(Arena.spriteSheets['menu'].img,this.position.x,this.position.y,this.size.x,this.size.y);

							for(var i = 0, len = this.buttons.length; i < len; i++){this.buttons[i].Render();}
						};
						Menu.prototype.unTrigger=function(type){
							if(!Arena.spriteSheets['menu'].img || !Arena.spriteSheets['menu'].spritesLoaded)return false;

							switch(type){
								case 'mousemove':
									//hit ya!
									this.resetButtons();
								break;

								case 'click':
								break;

								default:
									this.resetButtons();
								break;
							}
						};
						Menu.prototype.resetButtons = function() {
							for(var i = 0, len = this.buttons.length; i < len; i++){this.buttons[i].Reset();}
						};

						Menu.prototype.activate = function() {
							if(game.currentMenu!==this&&game.currentMenu!==null){game.currentMenu.deactivate();}
							game.currentMenu = this;
							this.active=true;
						};
						Menu.prototype.deactivate = function(_button) {
							this.unTrigger();
							this.active = false;
							if(_button&&_button.link){_button.link.active = true; game.currentMenu = _button.link;}
						};
						Menu.prototype.scrollList=function(e){
							if(!this.hasScroll)return false;


							var delta = e&&e.wheelDeltaY ? e.wheelDeltaY*0.3 : e&&e.detail ? e.detail : e&&typeof(e)==='number' ? e*0.8 : 0 >> 0;

							if(this.scrollTop <= -this.scrollBottom){this.scrollTop = -this.scrollBottom;}
							if(this.scrollTop >= 0){this.scrollTop = 0;}


							if(this.scrollTop+delta <= -this.scrollBottom || this.scrollTop+delta >= 0)return false;
							this.scrollTop += delta;

							for(var i = 0, len = this.buttons.length; i < len; i++){

								if(this.buttons[i].type !== 'ListElement')continue;

								this.buttons[i].scrollBounds(delta);
							}

						};
						Menu.prototype.changeMenu=function(_newmenu){
							this.deactivate();
							_newmenu.activate();
						};
						Menu.prototype.addPlayerScoreItem=function(_opts){

						};
						Menu.prototype.addListItem=function(_opts){
							var _li = new ListElement({
								x:60,
								y:this.listItems.length<=0 ? 72 : (this.listItems[this.listItems.length-1].position.y + this.listItems[this.listItems.length-1].size.y),
								w:360,
								h:20,
								dx:0,
								dy:0,
								textsize:8,
								text:_opts&&_opts.text || '1_ 1,200m Nick'
							});

							this.buttons.push(_li);
							this.listItems.push(this.buttons[this.buttons.length-1]);

							
							this.scrollDimensions.x = (71); 
							this.scrollDimensions.y = (142);

							this.scrollBottom = (this.listItems.length-1) * 20;
						};
						Menu.prototype.resetListItems=function(){
							for(var i = 0, len = this.buttons.length; i < len; i++){
								if(this.buttons[i].type === 'ListElement'){this.buttons.splice(1,i);}
							}
							this.listItems = [];

							this.scrollDimensions.x = 0; 
							this.scrollDimensions.y = 0;
							this.scrollBottom = 0;
						};

						Menu.Collision=function(obja,objb){
							if(objb.hasOwnProperty('active')&&!objb.active){return false;}
							return (obja.x) > objb.position.x  &&  (obja.x) < objb.position.x + objb.size.x
						        && (obja.y) > objb.position.y   &&  (obja.y) < objb.position.y + objb.size.y;
						};


						function MobileOverlayMenu(_opts){
							Menu.call(this,_opts);
						};
						MobileOverlayMenu.prototype = Object.create(Menu.prototype);
						MobileOverlayMenu.prototype.constructor=MobileOverlayMenu;
						MobileOverlayMenu.prototype.parent = Menu.prototype;

						MobileOverlayMenu.prototype.Render=function(){
							if(!this.active || !Arena.spriteSheets['mobileoverlayassets'].img || !Arena.spriteSheets['mobileoverlayassets'].spritesLoaded)return false;
							ctx.drawImage(Arena.spriteSheets['mobileoverlayassets'].img,this.dest.x,this.dest.y,this.size.x,this.size.y,this.position.x,this.position.y,this.size.x,this.size.y)
							for(var i = 0, len = this.buttons.length; i < len; i++){this.buttons[i].Render();}
						};


						function DesktopOverlayMenu(_opts){
							Menu.call(this,_opts);
						};
						DesktopOverlayMenu.prototype = Object.create(Menu.prototype);
						DesktopOverlayMenu.prototype.constructor=DesktopOverlayMenu;
						DesktopOverlayMenu.prototype.parent = Menu.prototype;

						DesktopOverlayMenu.prototype.Render=function(){
							if(!this.active || !Arena.spriteSheets['mobileoverlayassets'].img || !Arena.spriteSheets['mobileoverlayassets'].spritesLoaded)return false;
							for(var i = 0, len = this.buttons.length; i < len; i++){this.buttons[i].Render();}
						};




						//BUTTONS
						function Button(_opts){
							this.prevlink = _opts&&_opts.prevlink || null;
							this.link = _opts&&_opts.link || null;
							this.position = new Vector( _opts&&_opts.x || 0, _opts&&_opts.y || 0 );
							this.click = _opts&&_opts.click || true;
							this.size = new Vector( _opts&&_opts.w || 32, _opts&&_opts.h || 32 );
							this.srcsize = new Vector( _opts&&_opts.sw || this.size.x, _opts&&_opts.sh || this.size.y );
							this.dest = new Vector( _opts&&_opts.dx || 0, _opts&&_opts.dy || 0 );
							this.text = _opts&&_opts.text || '';
							this.hover = false;
							this.nohover = false;
							this.type = this.constructor.name;

							this.textSize = _opts&&_opts.textsize || 15;
							this.textPosition = new Vector(_opts&&_opts.tx || (this.position.x+32), _opts&&_opts.ty || ((this.position.y+(this.size.y))-(this.textSize*0.6)));
							this.bgAlpha = _opts&&_opts.bgAlpha || 0;
							this.textAlpha = _opts&&_opts.textAlpha || 0.5;

							this.bgAlphaBackUp = this.bgAlpha;
							this.textAlphaBackUp = this.textAlpha;

							this.action = _opts&&_opts.action || null;
						};
						Button.prototype.Reset=function(){
							this.textAlpha = this.textAlphaBackUp; this.bgAlpha = this.bgAlphaBackUp; this.hover=false;
						};
						Button.prototype.Trigger=function(type){return false;}
						Button.prototype.Initialise=function(_p){
							this.prevlink = _p;
						};




						function MobileOverlayImageButton(_opts){
							Button.call(this, _opts);
						};
						MobileOverlayImageButton.prototype = Object.create(Button.prototype);
						MobileOverlayImageButton.prototype.constructor=MobileOverlayImageButton;
						MobileOverlayImageButton.prototype.parent = Button.prototype;

						MobileOverlayImageButton.prototype.Trigger=function(type){
							if(!this.prevlink || this.prevlink&&!this.prevlink.active || !Arena.spriteSheets['mobileoverlayassets'].img || !Arena.spriteSheets['mobileoverlayassets'].spritesLoaded)return false;

							switch(type){
								case 'mousemove':
									//hit ya!
								break;

								case 'click':
									if(this.action===null || typeof(this.action)!=='function')return false;
									this.action();
									//do something?!	
								break;

							}
						};
						MobileOverlayImageButton.prototype.Render = function() {
							if(!this.prevlink || this.prevlink&&!this.prevlink.active || !Arena.spriteSheets['mobileoverlayassets'].img || !Arena.spriteSheets['mobileoverlayassets'].spritesLoaded )return false;
							ctx.drawImage(Arena.spriteSheets['mobileoverlayassets'].img,this.dest.x,this.dest.y,this.srcsize.x,this.srcsize.y,this.position.x,this.position.y,this.size.x,this.size.y);
						};


						function HealthBar(_opts){
							Button.call(this, _opts);
							this.dest2 = new Vector(_opts&&_opts.dx2 || 0,_opts&&_opts.dy2 || 0);
							this.dest3 = new Vector(_opts&&_opts.dx3 || 0,_opts&&_opts.dy3 || 0);
							this.amount = 1;
							this.barPosition = new Vector(_opts&&_opts.bx || 0,_opts&&_opts.by || 0);
							this.barSize = new Vector(_opts&&_opts.bw || 0,_opts&&_opts.bh || 0);
						};
						HealthBar.prototype = Object.create(Button.prototype);
						HealthBar.prototype.constructor=HealthBar;
						HealthBar.prototype.parent = Button.prototype;
						HealthBar.prototype.Render = function() {
							if(!Arena.spriteSheets['mobileoverlayassets'].img || !Arena.spriteSheets['mobileoverlayassets'].spritesLoaded )return false;
							
							//BG!
							ctx.drawImage(Arena.spriteSheets['mobileoverlayassets'].img,this.dest.x,this.dest.y,this.srcsize.x,this.srcsize.y,this.position.x,this.position.y,this.size.x,this.size.y);

							ctx.drawImage(Arena.spriteSheets['mobileoverlayassets'].img,this.dest2.x,this.dest2.y,this.barSize.x,this.barSize.y,this.barPosition.x,this.barPosition.y,this.barSize.x,this.barSize.y);
							//overlay -- make sure it deletes as the user health decreases and viceversa.
							this.amount = (g_Player.health/g_Player.maxhealth);
							this.amount *= this.barSize.x;
							if(this.amount)ctx.drawImage(Arena.spriteSheets['mobileoverlayassets'].img,this.dest3.x,this.dest3.y,this.amount,this.barSize.y,this.barPosition.x,this.barPosition.y,this.amount,this.barSize.y);

						};




						function CounterElement(_opts){
							Button.call(this, _opts);
							this.incrementElementAttr = _opts&&_opts.incElemOBJAttr || null;
							this.text = _opts&&_opts.text || '';
							this.textPosition = _opts&&_opts.textPosition || {x:0,y:0};
							this.textPosition.x += this.position.x;
							this.textPosition.y += this.position.y;
							this.amount = 0;
						};
						CounterElement.prototype = Object.create(Button.prototype);
						CounterElement.prototype.constructor=CounterElement;
						CounterElement.prototype.parent = Button.prototype;
						CounterElement.prototype.Render = function() {
							if(!Arena.spriteSheets['mobileoverlayassets'].img || !Arena.spriteSheets['mobileoverlayassets'].spritesLoaded || this.incrementElement===null || g_Player===null)return false;
							ctx.drawImage(Arena.spriteSheets['mobileoverlayassets'].img,this.dest.x,this.dest.y,this.srcsize.x,this.srcsize.y,this.position.x,this.position.y,this.size.x,this.size.y);

							
							ctx.save();
								ctx.fillStyle = '#333333';
								ctx.font = "12pt blocktext";
								this.amount = (g_Player[this.incrementElementAttr]);
								var _txt = this.amount.toString();
								ctx.fillText(_txt,this.textPosition.x,this.textPosition.y);
							ctx.restore();
						};




						function MenuElement(_opts){
							Button.call(this, _opts);
							this.color = _opts&&_opts.color || '255,255,255';
						};
						MenuElement.prototype = Object.create(Button.prototype);
						MenuElement.prototype.constructor=MenuElement;
						MenuElement.prototype.parent = Button.prototype;

						MenuElement.prototype.Trigger=function(type){
							if(!this.prevlink || this.prevlink&&!this.prevlink.active)return false;

							switch(type){
								case 'mousemove':
									//hit ya!
									this.hover=true;
									this.textAlpha = 1;
									this.bgAlpha = 0.5;
								break;

								case 'click':
									if(this.action===null || typeof(this.action)!=='function')return false;
									this.action();
									//do something?!	
								break;

							}
						};
						MenuElement.prototype.Render = function() {
							if(!this.prevlink || this.prevlink&&!this.prevlink.active)return false;

							ctx.save();
							
							ctx.fillStyle="rgba(255,255,255,"+this.bgAlpha+")";
							ctx.fillRect(this.position.x,this.position.y,this.size.x,this.size.y);

							ctx.fillStyle = "rgba("+this.color+","+this.textAlpha+")";
							ctx.font = this.textSize+"pt blocktext";
							ctx.fillText(this.text,this.textPosition.x,this.textPosition.y);
							
							ctx.restore();
						};




						function ImageElement(_opts){
							Button.call(this, _opts);
						};
						ImageElement.prototype = Object.create(Button.prototype);
						ImageElement.prototype.constructor=ImageElement;
						ImageElement.prototype.parent = Button.prototype;

						ImageElement.prototype.Trigger=function(type){
							if(!this.prevlink || this.prevlink&&!this.prevlink.active || !Arena.spriteSheets['menuassets'].img || !Arena.spriteSheets['menuassets'].spritesLoaded)return false;

							switch(type){
								case 'mousemove':
									//hit ya!
									this.hover=true;
									this.bgAlpha = 1;
								break;

								case 'click':
									if(this.action===null || typeof(this.action)!=='function')return false;
									this.action();
								break;

							}
						};
						ImageElement.prototype.Render = function() {
							if(!this.prevlink || this.prevlink&&!this.prevlink.active || !Arena.spriteSheets['menuassets'].img || !Arena.spriteSheets['menuassets'].spritesLoaded )return false;
							ctx.globalAlpha = this.bgAlpha;
							ctx.drawImage(Arena.spriteSheets['menuassets'].img,this.dest.x,this.dest.y,this.srcsize.x,this.srcsize.y,this.position.x,this.position.y,this.size.x,this.size.y);
							ctx.globalAlpha = 1;
						};


						function HeaderElement(_opts){
							Button.call(this, _opts);

							this.subtext = _opts&&_opts.subtext || '';
							this.subtextSize = _opts&&_opts.subtextsize || 15;
							
							this.subtextPosition = new Vector(_opts&&_opts.stx || ((this.position.x+128)+(ctx.measureText(this.text).width)), _opts&&_opts.sty || ((this.position.y+(this.size.y))-(this.subtextSize*1.2)));

						};
						HeaderElement.prototype = Object.create(Button.prototype);
						HeaderElement.prototype.constructor=HeaderElement;
						HeaderElement.prototype.parent = Button.prototype;

						HeaderElement.prototype.Render = function() {
							if(!this.prevlink || this.prevlink&&!this.prevlink.active)return false;

							ctx.fillStyle="#666666";
							ctx.fillRect(this.position.x,this.position.y,this.size.x,this.size.y);

							ctx.fillStyle = "rgba(255, 255, 255,1)";
							ctx.font = this.textSize+"pt blocktext";
							ctx.fillText(this.text,this.textPosition.x,this.textPosition.y);

							ctx.fillStyle = "#cccccc";
							ctx.font = this.subtextSize+"pt blocktext";
							ctx.fillText(this.subtext,this.subtextPosition.x,this.subtextPosition.y);

						};


						function AboutusElement(_opts){
							Button.call(this, _opts);
							this.textarr = _opts&&_opts.textarr || [];
							this.size.y = this.textarr.length <= 0 ? 0 : ((this.textarr.length)*(this.textSize+4))+4;
							this.nohover = true;
						};
						AboutusElement.prototype = Object.create(Button.prototype);
						AboutusElement.prototype.constructor=AboutusElement;
						AboutusElement.prototype.parent = Button.prototype;

						AboutusElement.prototype.Render = function() {
							if(!this.prevlink || this.prevlink&&!this.prevlink.active)return false;

							ctx.fillStyle="#666666";
							ctx.fillRect(this.position.x,this.position.y,this.size.x,this.size.y);
							
							for(var i = 0, len = this.textarr.length; i < len; i++){
								ctx.fillStyle = "rgba(255, 255, 255,1)";
								ctx.font = this.textSize+"pt blocktext";
								ctx.fillText(this.textarr[i],this.position.x+4,(this.position.y+(i+1) * (this.textSize+4)));
							}
						};


						function JeffElement(_opts){
							Button.call(this, _opts);
							this.nohover=true;
						};
						JeffElement.prototype = Object.create(Button.prototype);
						JeffElement.prototype.constructor=JeffElement;
						JeffElement.prototype.parent = Button.prototype;

						JeffElement.prototype.Render = function() {
							if(!this.prevlink || this.prevlink&&!this.prevlink.active || !Arena.spriteSheets['jeff'].img || !Arena.spriteSheets['jeff'].spritesLoaded )return false;
							ctx.drawImage(Arena.spriteSheets['jeff'].img,this.position.x,this.position.y,this.size.x,this.size.y);
						};



						function ListElement(_opts){
							Button.call(this, _opts);

							this.active = _opts&&_opts.active || true;
						};
						ListElement.prototype = Object.create(Button.prototype);
						ListElement.prototype.constructor=ListElement;
						ListElement.prototype.parent = Button.prototype;

						ListElement.prototype.Trigger=function(type){
							if(!this.prevlink || this.prevlink&&!this.prevlink.active || !this.active)return false;

							switch(type){
								case 'mousemove':
									//hit ya!
									this.hover=true;
									this.textAlpha = 1;
									this.bgAlpha = 0.5;
								break;

								case 'click':
									if(this.action===null || typeof(this.action)!=='function')return false;
									this.action();
									//do something?!	
								break;

							}
						};
						ListElement.prototype.Render = function() {
							if(!this.prevlink || this.prevlink&&!this.prevlink.active || !this.active)return false;

							ctx.save();
							
							ctx.fillStyle="rgba(255,255,255,"+this.bgAlpha+")";
							ctx.fillRect(this.position.x,this.position.y,this.size.x,this.size.y);

							ctx.fillStyle = "rgba(255, 255, 255,"+this.textAlpha+")";
							ctx.font = this.textSize+"pt blocktext";
							ctx.fillText(this.text,this.textPosition.x,this.textPosition.y);
							
							ctx.restore();
						};

						ListElement.prototype.scrollBounds=function(pos){
							if(!pos)return false;
							this.position.y += typeof(pos)==='boolean' ? 0 : pos;
							this.textPosition.y += typeof(pos)==='boolean' ? 0 : pos;

							if((this.position.y) <= this.prevlink.scrollDimensions.x || (this.position.y) >= this.prevlink.scrollDimensions.y){
								this.active = false;
							}else{
								this.active = true;
							}
						};
						ListElement.prototype.Initialise=function(_p){
							this.parent.Initialise.call(this,_p);
							this.scrollBounds(true);
						}



						/*
						Main Menu
						*/
						function MainMenu(_opts){
							this.name = _opts&&_opts.name || 'MENU';
							this.queryID = _opts&&_opts.queryID || '';
							this.parentQueryID = _opts&&_opts.parentQueryID || '';
						};
						MainMenu.prototype.On=function(){
							game.currentMenu = g_Menus[this.name];
							$(this.parentQueryID).addClass('active');
							$(this.queryID).addClass('active');
						};
						MainMenu.prototype.Off=function(){
							$(this.queryID).removeClass('active');
							$(this.parentQueryID).removeClass('active');
						};
						MainMenu.prototype.changeMenu=function(_menu){
							game.previousMenu = g_Menus[this.name];
							this.Off();
							_menu.On();
						};

						MainMenu.Actions=function(_id){
							$(_id+' .text').on('click',function(e){
								if($(this).hasClass('logout')){ sounds.select.play();  GAME_HANDLER.Logout(); return true;}else
								if($(this).hasClass('play')){ game.restart(); sounds.select.play(); game.gameState = game.STATES.PLAY; sounds.background.play(); game.currentMenu.Off(); return true;}else
								if($(this).hasClass('leaderboards')){ GAME_HANDLER.GetScore(); sounds.select.play(); if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['leaderboards']); return true; }  g_Menus['leaderboards'].On();  return true;}else
								if($(this).hasClass('about')){sounds.select.play(); if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['about']); return true; }  g_Menus['about'].On(); return true;}else
								if($(this).hasClass('settings')){sounds.select.play(); if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['settings']); return true; }  g_Menus['settings'].On(); return true;}else
								if($(this).hasClass('restart')){sounds.select.play(); game.restart(); game.gameState = game.STATES.PLAY; sounds.background.play(); game.currentMenu.Off(); return true;}else
								if($(this).hasClass('resume')){sounds.select.play(); sounds.background.play(); game.gameState = game.STATES.PLAY; game.currentMenu.Off(); return true;}else
								
								if($(this).hasClass('quit')){ sounds.select.play(); if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['home']); return true; } g_Menus['home'].On(); return true; }else
								

								if($(this).hasClass('audio')){sounds.select.play(); sfx=!sfx; $(this).toggleClass('active'); return true;}else
								if($(this).hasClass('music')){sounds.select.play(); music=!music; $(this).toggleClass('active'); return true;}else
								if($(this).hasClass('start')){sounds.select.play(); GAME_HANDLER.Login(); return true;}else
								if($(this).hasClass('register')){sounds.select.play(); if(game.currentMenu){ game.currentMenu.changeMenu(g_Menus['register']); } return true;}else
								if($(this).hasClass('agreeandstart')){sounds.select.play(); GAME_HANDLER.Register(); return true;}
							});
							$(_id+' .text, '+_id+' .back').hover(function(){
								sounds.menunavigate.play();
							});
							$(_id+' .back').on('click',function(e){ if(game.previousMenu)game.currentMenu.changeMenu(game.previousMenu); return true; });

							
						};


						function MobileMenu(_opts){
							this.name = _opts&&_opts.name || 'MENU';
							this.queryID = _opts&&_opts.queryID || '';
							this.parentQueryID = _opts&&_opts.parentQueryID || '';
						};
						MobileMenu.prototype.On=function(){
							game.currentMobileMenu = g_MobileMenu[this.name];
							$(this.parentQueryID).addClass('active');
							$(this.queryID).addClass('active');
						};
						MobileMenu.prototype.Off=function(){
							$(this.queryID).removeClass('active');
							$(this.parentQueryID).removeClass('active');
						};
						MobileMenu.prototype.changeMenu=function(_menu){
							game.previousMobileMenu = g_MobileMenu[this.name];
							this.Off();
							_menu.On();
						};

						MobileMenu.Actions=function(_id){
							$(_id+' .mobileaction').on('touchstart',function(e){
								console.log('hit!');
								if($(this).hasClass('jump')){ if(g_Player&&g_Player!==null)g_Player.Jump(); return true;}
								if($(this).hasClass('start')){ if(game.gameState===game.STATES.PLAY){ sounds.background.stop(); game.gameState = game.STATES.MENU; game.currentMenu.changeMenu(g_Menus['ingame-pause']);} return true;}
								if($(this).hasClass('a')){ if(g_Player&&g_Player!==null)g_Player.Shoot(); return true;}
								if($(this).hasClass('b')){ if(g_Player&&g_Player!==null)g_Player.changeWeapon(true); return true;}
							});
						}









						;
								if(!isMobile()){
						   $(function ()
						   {

						      var socket = io.connect('http://santass.herokuapp.com');
						       
						      socket.on('welcome', function()
						      {
						         socket.emit("device", {"type":"game"});
						      });

						      socket.on("initialize", function(gameCode)
						      {
						         var qrcode = new QRCode("qrcode");
						         qrcode.makeCode('http://christmas.vitaminlondon.com/15/socket/controller.html?gc=' + gameCode);

						         console.log('http://christmas.vitaminlondon.com/15/socket/controller.html?gc=' + gameCode);
						      });

						      socket.on("connected", function()
						      {
						         // connection established
						      });

						      socket.on('disconnected', function()
						      { 
						         window.location.reload();
						      });


						      socket.on('jump', function()
						      { 
						        g_Player.Jump(); 
						      });

						      socket.on('up', function()
						      {  
						         console.log('hit up');
						      });
						      socket.on('down', function()
						      {
						         console.log('hit down');
						      });
						      socket.on('left', function()
						      {
						         console.log('hit left');
						      });
						      socket.on('right', function()
						      {
						        console.log('hit right');
						      });

						      socket.on('start', function()
						      {
						         if(game.gameState===game.STATES.PLAY){sounds.background.stop(); game.gameState = game.STATES.MENU; game.currentMenu.changeMenu(g_Menus['ingamemenu']);}
						      });

						      socket.on('a', function()
						      {
						         g_Player.changeWeapon(true);
						        //change weapon
						      });

						      socket.on('b', function()
						      {
						         //shoot
						         g_Player.Shoot();
						      });
						   });
						};


						/*
						var getShortUrl = function (longUrl, cb)
						{
						   $.ajax({
						      url: 'https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyBNmtrVhiWeAelz6W-1N_Xeuq8H6OYI27U',
						      type: 'POST',
						      contentType: 'application/json; charset=utf-8',
						      data: JSON.stringify({
						         "longUrl": longUrl
						      }),
						      dataType: 'json',
						      complete: function(response) 
						      {
						         var shortUrl = '';
						         try {
						            shortUrl = JSON.parse(response.responseText).id;
						         }
						         catch (err) {
						            shortUrl = '';
						         }

						         cb (shortUrl);
						      }
						   });
						};
						*/
						;
								var sounds = {
							jump:{
								audio:document.getElementById("jump"),
								play:function(){ if(!sfx)return false; sounds.jump.audio.pause(); sounds.jump.audio.currentTime=0; sounds.jump.audio.play(); },
								stop:function(){ if(!sfx)return false; sounds.jump.audio.pause(); sounds.jump.audio.currentTime=0; }
							},
							bazooka:{
								audio:document.getElementById("bazooka"),
								play:function(){ if(!sfx)return false; sounds.bazooka.audio.pause(); sounds.bazooka.audio.currentTime=0; sounds.bazooka.audio.play(); },
								stop:function(){ if(!sfx)return false; sounds.bazooka.audio.pause(); sounds.bazooka.audio.currentTime=0; }
							},
							gun:{
								audio:document.getElementById("gun"),
								play:function(){ if(!sfx)return false; sounds.gun.audio.pause(); sounds.gun.audio.currentTime=0; sounds.gun.audio.play(); },
								stop:function(){ if(!sfx)return false; sounds.gun.audio.pause(); sounds.gun.audio.currentTime=0; }
							},
							background:{
								audio:document.getElementById("bg"),
								play:function(){ if(!music)return false; sounds.background.audio.pause(); sounds.background.audio.currentTime=0; sounds.background.audio.play(); },
								stop:function(){ if(!music)return false; sounds.background.audio.pause(); sounds.background.audio.currentTime=0; }
							},
							menunavigate:{
								audio:document.getElementById("menunavigate"),
								play:function(){ if(!sfx)return false; sounds.menunavigate.audio.pause(); sounds.menunavigate.audio.currentTime=0; sounds.menunavigate.audio.play(); },
								stop:function(){ if(!sfx)return false; sounds.menunavigate.audio.pause(); sounds.menunavigate.audio.currentTime=0; }
							},
							select:{
								audio:document.getElementById("select"),
								play:function(){ if(!sfx)return false; sounds.select.audio.pause(); sounds.select.audio.currentTime=0; sounds.select.audio.play(); },
								stop:function(){ if(!sfx)return false; sounds.select.audio.pause(); sounds.select.audio.currentTime=0; }
							},
							explosion:{
							audio:document.getElementById("explosion"),
								play:function(){ if(!sfx)return false; sounds.explosion.audio.pause(); sounds.explosion.audio.currentTime=0; sounds.explosion.audio.play(); },
								stop:function(){ if(!sfx)return false; sounds.explosion.audio.pause(); sounds.explosion.audio.currentTime=0; }
							}
						};

						sounds.jump.audio.volume = 0.5;
						sounds.bazooka.audio.volume = 0.5;
						sounds.gun.audio.volume = 0.5;
						sounds.background.audio.volume = 0.2;
						sounds.menunavigate.audio.volume = 0.3;
						sounds.select.audio.volume = 0.3;
						sounds.explosion.audio.volume = 0.5;;
								var isTouch = "ontouchend" in document;
						//var g_TouchObj = null;
						var styles = {};
						var pref = null;
						var scale = 0;
						user = {
							Start:function(){

								/*if(isMobile()){
									g_TouchObj = new touchObject(canvas);
								}*/

							},
							events:function(){
								$(document).ready(function(){
								    
								    $(window).resize(function(){
						               $('canvas').height($('canvas').width() * 0.5);
						               $('canvas').attr('width',playWidth);
						               $('canvas').attr('height',playHeight);

						  			   $(oCanvas).height($('canvas').width() * 0.5);
						               $(oCanvas).attr('width',playWidth);
						               $(oCanvas).attr('height',playHeight);

						               mouse.sx = playWidth / canvas.offsetWidth;
						    		   mouse.sy = playHeight / canvas.offsetHeight;

						    		  	pref = prefix.css+'transform';
						    		  	scale = $('canvas').height() / 240;	
						    		  	styles[pref] = 'scale('+scale+')';
						    		  	styles['margin'] = '0 '+$('canvas').offset().left+'px';
						    		   	$('article.menu, article.overlays').css(styles);
						            }).resize();

									//if(debug){
										$(document).on('keydown',function(e){
											if(game.gameState!==game.STATES.PLAY || !debug)return true;
											e.preventDefault();
											var ee = e.originalEvent;
											if(ee.which === 65){leftkey = !0;}
											if(ee.which === 68){rightkey = !0;}
											if(ee.which === 87){upkey = !0;}
											if(ee.which === 83){downkey = !0;}
										});
										$(document).on('keyup',function(e){
											if(game.gameState!==game.STATES.PLAY || !debug)return true;
											e.preventDefault();
											leftkey = !1;
											rightkey = !1;
											upkey = !1;
											downkey = !1;
										});
										//return;
									//}

									if(isMobile()){
										user.move('touchstart', 'touchend');
									}else{
										user.move('keydown mousedown', 'keyup mouseup', 'mousemove', 'mousewheel DOMMouseScroll');
									}
								});
							},
							/*checkOverlayCollision:function(e){
								var px = e.originalEvent.touches ? e.originalEvent.touches[0].pageX : e.originalEvent.pageX,
									py = e.originalEvent.touches ? e.originalEvent.touches[0].pageY : e.originalEvent.pageY;

								mouse.x = (getOffsetX(px))*(mouse.sx) >> 0;
								mouse.y = (getOffsetY(py))*(mouse.sy) >> 0;
								
								for(var i = 0, len = game.currentOverlay.buttons.length; i < len; i++){
									if(Menu.Collision(mouse,game.currentOverlay.buttons[i])){ return {hit:true,index:i}; }
								};

								return {hit:false};
							},
							checkMenuCollision:function(e){

								if(game.currentMenu===null || !game.currentMenu.active)return true;

								var px = e.originalEvent.touches ? e.originalEvent.touches[0].pageX : e.originalEvent.pageX,
									py = e.originalEvent.touches ? e.originalEvent.touches[0].pageY : e.originalEvent.pageY;

								mouse.x = (getOffsetX(px))*(mouse.sx) >> 0;
								mouse.y = (getOffsetY(py))*(mouse.sy) >> 0;
								
								for(var i = 0, len = game.currentMenu.buttons.length; i < len; i++){
									if(Menu.Collision(mouse,game.currentMenu.buttons[i])){ return {hit:true,index:i}; }
								};

								return {hit:false};
							},	*/
							move:function(downkeys,upkeys,keymove,keyscroll){
								
								/*$(canvas).on(keyscroll,function(e){
									e.preventDefault();
									if(!e || game.currentMenu===null || !game.currentMenu.active)return true;

									switch(e.type){
										case 'DOMMouseScroll':
										case 'mousewheel':
											if(game.gameState===game.STATES.MENU)game.currentMenu.scrollList(e.originalEvent);
										break;
									};

								});*/


								/*$(canvas).on(keymove,function(e){
									e.preventDefault();
									if(!e || game.currentMenu===null || !game.currentMenu.active)return true;

									switch(e.type){
										case 'mousemove':
											if(game.gameState===game.STATES.MENU){
												var _c = user.checkMenuCollision(e);
												if(_c&&_c.hit){if(!game.currentMenu.buttons[_c.index].hover&&!game.currentMenu.buttons[_c.index].nohover)sounds.menunavigate.play(); game.currentMenu.unTrigger('mousemove'); game.currentMenu.buttons[_c.index].Trigger('mousemove');}else{game.currentMenu.unTrigger('mousemove');}
											};
										break;
									};
								});*/

								$(document).on(downkeys,function(e){
									//e.preventDefault();

									if(!e)return true;
									//keycodes
									/*
										w - 87
										s - 83
										a - 65
										d - 68
										space - 32
									*/

									switch(e.type){
										case 'mousedown':
										case 'touchstart':

											/*if(game.gameState===game.STATES.MENU && game.currentMenu!==null && game.currentMenu.active){
												e.preventDefault();
												var _c = user.checkMenuCollision(e);
												if(_c&&_c.hit){sounds.select.play(); game.currentMenu.buttons[_c.index].Trigger('click');}
											}*/
											if(game.gameState===game.STATES.PLAY){
												/*if(e.type==='touchstart' && isMobile() && game.currentOverlay!==null && game.currentOverlay.active){
													var _c = user.checkOverlayCollision(e);
													if(_c&&_c.hit){ game.currentOverlay.buttons[_c.index].Trigger('click');}
												}else{*/
												if(e.type!=='touchstart' && !isMobile()){
													if(g_Player!==null&&!g_Player.dead)g_Player.Jump();
												}
											}

										break;

										case 'keydown':
											//e.preventDefault();
											switch(e.which){
												case 49:
													if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead){e.preventDefault(); g_Player.changeWeapon('machinegun');}
												break;

												case 50:
													if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead){e.preventDefault(); g_Player.changeWeapon('bazooka'); }
												break;
												
												case 27:
													if(debug)game.restart();
												break;
												case 80: // p
													if(game.gameState===game.STATES.PLAY){ e.preventDefault(); sounds.background.stop(); game.gameState = game.STATES.MENU; game.currentMenu.changeMenu(g_Menus['ingame-pause']);}
												break;
												
												case 66:
													if(game.gameState===game.STATES.PLAY){e.preventDefault(); debug = !debug;}
												break;

												case 87:
												case 38:
													if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead){ e.preventDefault(); g_Player.Jump(); }
												break;

												case 32:
													if(game.gameState===game.STATES.PLAY&&g_Player!==null){e.preventDefault();}
													if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead){ g_Player.Shoot(); }
												break;
											};
										break;
									};
								});

								$(document).on(upkeys,function(e){
									//e.preventDefault();

									if(!e)return;
									
									//if(g_Player&& g_Player.dead && g_Player.isGrounded){game.restart(); return;}
									
									switch(e.type){

										case 'keyup':
											switch(e.which){
												case 87:
												case 38:
													if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead){ e.preventDefault(); g_Player.Fall(); }
												break;

												case 32:
													if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead){ e.preventDefault(); g_Player.StopShoot(); }
												break;
											};
										break;

										case 'mouseup':
										case 'touchend':
											if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead){ e.preventDefault(); g_Player.Fall(); }
											if(game.gameState===game.STATES.PLAY&&g_Player!==null&&!g_Player.dead&&e.type==='touchend'){e.preventDefault(); g_Player.StopShoot();}
										break;
									};
								});
							}
						};


						/*function touchObject(element)
						{
						  var self = this;
						  this.prev = {x:0, y:0};
						  this.now = {x:0, y:0};


						  function handleHammer(ev) {

						 	if(game.gameState!==game.STATES.MENU)return false;

						    // disable browser scrolling
						    //ev.gesture.preventDefault();

						    switch(ev.type) {
						      case 'dragstart':
						      	self.prev.x = ev.gesture.touches[0].pageX;
						      	self.prev.y = ev.gesture.touches[0].pageY;
						      break;


						      case 'dragup':
						      case 'dragdown':
						      
						      self.now.x = ev.gesture.touches[0].pageX;
						      self.now.y = ev.gesture.touches[0].pageY;

						      var delta = -(self.prev.y - self.now.y);
						      
						      game.currentMenu.scrollList(delta);

						       self.prev.x = ev.gesture.touches[0].pageX;
						       self.prev.y = ev.gesture.touches[0].pageY;


						      break;
						   }
						  }

						  new Hammer($('canvas#game'), { dragLockToAxis: true }).on("dragstart dragup dragdown", handleHammer);
						}*/


						user.Start();;
								function Utilities(){
							this.now = null;
							this.delta = null;
							this.then = null;
							this.start = Date.now();
							this.accumulator = 0.0;
							this.fixedDelta = 0.01;
							this.secondDelta = 0;
							this.FPS = 1000/60;
							
							//this.worker =  new Worker("worker.js");
							/*
							CHARACTER SPECIFIC
							*/
							this.characterNow = 0;
							this.characterThen = 0;
							this.characterDelta = 0; 


							/*ENEMIES*/
							this.oldd = 0;
							this.randomEnemyAmount = 2;

							/* PLAYER */
							this.olddp = 0;
							this.randomPlayerAmount = 20;

							/* ARENA */
							this.oldde = 0;
							this.randomEvilAmount = 1;

						};
						Utilities.prototype.Update=function(){

							if(debug)return false;

							//this.delta
							this.secondDelta = this.now - this.start;
							this.secondDelta /= 1000;
							this.secondDelta = Math.round(this.secondDelta);

							// Every 5 seconds release an enemy!
							if(this.secondDelta % this.randomEnemyAmount === 0 && this.secondDelta !== 0 && this.secondDelta !== this.oldd){
								this.oldd = this.secondDelta;
								this.randomEnemyAmount = 2;
								//pick a random enemy logic
								if(g_Enemies.length > 0)g_Enemies[Math.round(Math.random() * (g_Enemies.length-1))].Logic();
							}

							if(this.secondDelta % this.randomPlayerAmount === 0 && this.secondDelta !== 0 && this.secondDelta !== this.olddp){
								this.olddp = this.secondDelta;
								this.randomPlayerAmount = 20;
								// do something
								g_Player.increaseSpeed();
							}

							if(this.secondDelta % this.randomEvilAmount === 0 && this.secondDelta !== 0 && this.secondDelta !== this.oldde){
								this.oldde = this.secondDelta;
								this.randomEvilAmount = 1;
								// do something
								//pick a random enemy logic
								g_Level.evilWorld();
							}


						};

						Utilities.prototype.Restart=function(){
							this.now = null;
							this.delta = null;
							this.then = null;
							this.start = Date.now();
						};
						 ;
								function Particle(_opts){
							var self = this;
							this._id = _opts.id || null;
							this.position = new Vector(_opts.x || 0,_opts.y || 0);
							this.size = new Vector(_opts.w || 0, _opts.h || 0);
							this.srcsize = new Vector(_opts.sw || 0, _opts.sh || 0);
							this.velocity = new Vector(_opts.velocity.x,_opts.velocity.y);
							this.velocityold = new Vector(_opts.velocity.x,_opts.velocity.y);
							this.inView = true;
							this.collision = false;
							this.dead = true;
							this.type = this.constructor.name;
							this.layer = -1;
							this.angle = _opts.angle*(Math.PI/180) || 45*(Math.PI/180);
							this.dest = new Vector(_opts.dx || 0, _opts.dy || 0);
							this.alpha = 1;
							this.delay = _opts.delay || 0;
							this.currentDelay = 0;
							this.active = false;
						};

						Particle.prototype.Render=function(){
							if(!Arena.spriteSheets['particles'].spritesLoaded || this.dead || !this.active)return false;
							this.inView = true;
							return true;
							
						};
						Particle.prototype.Restart=function(){
							this.Die();
						};
						Particle.prototype.Alive=function(_cp){
							this.position.x = _cp.x;
							this.position.y = _cp.y;
							this.velocity.x = this.velocityold.x;
							this.velocity.y = this.velocityold.y;
							this.dead = false;
							this.inView = true;
							this.alpha = 1;
							this.active = false;
						};
						Particle.prototype.Die=function(){
							this.dead=true;
							this.inView = false;
							this.position.x = -1000;
							this.position.y = -1000;
							this.velocity.x = this.velocityold.x;
							this.velocity.y = this.velocityold.y;
							this.currentDelay = 0;
							this.active = false;
							this.alpha = 1;
						};
						Particle.prototype.Update=function(){
							if(this.dead)return false;
							if((this.position.x-g_Level.viewport.x) > playWidth || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)<= 0 || (this.position.y >= playHeight+g_Level.viewport.y)){this.Die(); return;}
							if(this.currentDelay++ < this.delay){return false;}
							return true;

						};;
								function Explosion(_opts){
							this.position = new Vector(_opts&&_opts.x || -1000, _opts&&_opts.y || -1000);
							this.size = new Vector(_opts&&_opts.w || 32, _opts&&_opts.h || 32);
							this.srcsize = new Vector(_opts&&_opts.sw || 96, _opts&&_opts.sh || 96);
							this.dest = new Vector(_opts&&_opts.dx || 96, _opts&&_opts.dy || 128);
							this.inView = true;
							this.collision = false;
							this.active = false;

							this.currentFrameX = 0;
							this.maxFrameX = 5;
							this.frameDelay = 0;
							this.frameDelayAmount = 2;

							this.minSize = 32;
							this.maxSize = 160;

						};

						Explosion.prototype.Render=function(){
							if(!Arena.spriteSheets['explosion'] || !Arena.spriteSheets['explosion'].img || !Arena.spriteSheets['explosion'].spritesLoaded || !this.inView || !this.active){return false;}
							this.Animate();
							ctx.drawImage(Arena.spriteSheets['explosion'].img, this.dest.x*this.currentFrameX, this.dest.y, this.srcsize.x,this.srcsize.y, ((this.position.x-(this.size.x/2)) - g_Level.viewport.x - g_Level.shakeViewport.x), (this.position.y-(this.size.x/2)) - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						};
						Explosion.prototype.Update=function(){
							if(((this.position.x)-g_Level.viewport.x) >= (playWidth) || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight) || !this.active || !this.inView){this.Die(); return;}
							if(!this.inView)this.inView = true;

							this.size.x+=15; //maybe remove these {
							this.size.y+=15; // }

							if(this.size.x >= this.maxSize)this.size.x=this.maxSize;
							if(this.size.y >= this.maxSize)this.size.y=this.maxSize;
						};
						Explosion.prototype.Animate=function(){
							if(this.frameDelay++ > this.frameDelayAmount)
							{
								this.frameDelay = 0;
								this.currentFrameX++;
								if(this.currentFrameX >= this.maxFrameX)
								{	
									this.Die();
									//this.currentFrameX = 0;
								}
							}
						}
						Explosion.prototype.evilWorld=function(){}
						Explosion.prototype.Die=function(){ this.inView = false; this.active = false; }
						Explosion.prototype.Restart=function(){
							this.Die();
						};
						Explosion.prototype.Spawn=function(_opts){
							this.inView=true;
							this.active=true;
							this.currentFrameX = 0;
							this.position.x = _opts.x;
							this.position.y = _opts.y;
							this.size.x = this.minSize;
							this.size.y = this.minSize;
						};;
								function CharacterParticle(_opts){
							Particle.call(this,_opts);
							this.finished = false;
						};
						CharacterParticle.prototype = Object.create(Particle.prototype);
						CharacterParticle.prototype.constructor=CharacterParticle;
						CharacterParticle.prototype.parent = Particle.prototype;

						CharacterParticle.prototype.Render=function(){
							if(!this.parent.Render.call(this))return false;
							ctx.drawImage(Arena.spriteSheets['particles'].img, this.dest.x, this.dest.y, this.srcsize.x,this.srcsize.y, this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x, this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						};

						CharacterParticle.prototype.Update=function(){
							if(!this.parent.Update.call(this) || this.finished)return false;
							
							this.active=true;
							this.position.x += (Math.cos(this.angle) * this.velocity.x);

							this.velocity.y -= Character.gravity;
							if(this.velocity.y <= 0){
								this.position.y += (this.velocity.y*-1);
							}else{
								this.position.y -= (this.velocity.y);
							}
							
							if(this.position.y >= ((g_Level.levels[g_Level.currentLevel].scrollHeight-Arena.TILESIZE)))this.finished = true;
						};
						CharacterParticle.prototype.Alive=function(_cp){
							this.finished = false;
							this.parent.Alive.call(this,_cp);
						};
						;
								function ExplosionParticle(_opts){
							Particle.call(this,_opts);
							this.finished = false;
						};
						ExplosionParticle.prototype = Object.create(Particle.prototype);
						ExplosionParticle.prototype.constructor=ExplosionParticle;
						ExplosionParticle.prototype.parent = Particle.prototype;

						ExplosionParticle.prototype.Render=function(){
							if(!this.parent.Render.call(this))return false;
							ctx.globalAlpha = this.alpha;
								ctx.drawImage(Arena.spriteSheets['particles'].img, this.dest.x, this.dest.y, this.srcsize.x,this.srcsize.y, this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x, this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
							ctx.globalAlpha = 1;

							this.alpha -= 0.02;
							if(this.alpha <= 0){ this.Die(); }

						};

						ExplosionParticle.prototype.Update=function(){
							if(!this.parent.Update.call(this) || this.finished)return false;
							
							this.active=true;
							this.position.x += (Math.cos(this.angle) * this.velocity.x);
							this.position.y += (Math.sin(this.angle) * this.velocity.y);
						};
						ExplosionParticle.prototype.Alive=function(_cp){
							this.finished = false;
							this.parent.Alive.call(this,_cp);
						};
						;
								function BloodParticle(_opts){
							Particle.call(this,_opts);
						};
						BloodParticle.prototype = Object.create(Particle.prototype);
						BloodParticle.prototype.constructor=BloodParticle;
						BloodParticle.prototype.parent = Particle.prototype;

						BloodParticle.prototype.Render=function(){
							if(!this.parent.Render.call(this))return false;
							/*ctx.save();*/
								ctx.globalAlpha = this.alpha;
								ctx.drawImage(Arena.spriteSheets['particles'].img, this.dest.x, this.dest.y, this.srcsize.x,this.srcsize.y, this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x, this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
								ctx.globalAlpha = 1;
							/*ctx.restore();*/
							
							this.alpha -= 0.04;
							if(this.alpha <= 0){ this.Die(); }
						};

						BloodParticle.prototype.Update=function(){
							if(!this.parent.Update.call(this) || this.finished)return false;
							
							this.active=true;
							this.position.x += (Math.cos(this.angle) * this.velocity.x);
							this.position.y += (Math.sin(this.angle) * this.velocity.y);

						};;
								function GunParticle(_opts){
							Particle.call(this,_opts);
						};
						GunParticle.prototype = Object.create(Particle.prototype);
						GunParticle.prototype.constructor=GunParticle;
						GunParticle.prototype.parent = Particle.prototype;

						GunParticle.prototype.Render=function(){
							if(!this.parent.Render.call(this))return false;
							ctx.drawImage(Arena.spriteSheets['particles'].img, this.dest.x, this.dest.y, this.srcsize.x,this.srcsize.y, this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x, this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						};

						GunParticle.prototype.Update=function(){
							if(!this.parent.Update.call(this) || this.finished)return false;
							

							this.active=true;
							this.position.x += (Math.cos(this.angle) * this.velocity.x);

							this.velocity.y -= Character.gravity;
							if(this.velocity.y <= 0){
								this.position.y += (this.velocity.y*-1);
							}else{
								this.position.y -= (this.velocity.y);
							}
							
							if(this.position.y >= playHeight+g_Level.viewport.y)this.Die();

						};
						GunParticle.prototype.Alive=function(_cp){
							if(!this.dead || this.active)return false;

							this.parent.Alive.call(this,_cp);
						};;
								function Gun(_opts){
							var self = this;
							this._id = _opts.id || null;
							this.position = new Vector(_opts.x || 0,_opts.y || 0);
							this.size = new Vector(_opts.w || 0, _opts.h || 0);
							this.velocity = new Vector(_opts.velocity.x,_opts.velocity.y);
							this.inView = true;
							this.collision = false;
							this.type = this.constructor.name;
							this.layer = -1;
							this.notinuse = _opts.notinuse || true;
							this.offset = _opts.offset || {x:0,y:0};
							this.image = null;

							this.currentState = Gun.MUZZLES[this.type].IDLE;

							this.frameDelay = 0;
							this.frameDelayAmount = 1;
							this.currentFrameX = this.currentState.start.x;
							this.currentFrameY = this.currentState.end.x;
							this.maxFrameY = this.currentState.end.y;
							this.maxFrameX = this.currentState.start.y;

							this.particles = [];
							this.createParticles();
						};
						Gun.MUZZLES = {
							MachineGun:{
								IDLE:{start:{x:0, y:0}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,size:{x:32,y:32},moffset:{x:0,y:0},offset:{x:64,y:0}, name:'MachineGunIdle'},
								FIRE:{start:{x:0, y:2}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,size:{x:32,y:32},moffset:{x:-3,y:-1},offset:{x:0,y:0}, name:'MachineGunFire'},
							},
							Bazooka:{
								IDLE:{start:{x:0, y:0}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,size:{x:32,y:32},moffset:{x:0,y:0},offset:{x:0,y:32}, name:'BazookaIdle'},
								FIRE:{start:{x:0, y:0}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,size:{x:32,y:32},moffset:{x:0,y:0},offset:{x:0,y:32}, name:'BazookaFire'},
							},
						};

						Gun.prototype.Shoot=function(){
							//for(var i = 0; i < this.particles.length; i++){
								this.particles[Math.round(Math.random() * (this.particles.length-1))].Alive({x:(this.position.x), y:(this.position.y)});
							//}
						};
						Gun.prototype.createParticles=function(){
							var ii = 0;
							for(var i = 0; i < 20; i++){
								var _angle = (Math.random() * (360)) >> 0;
								this.particles.push(new GunParticle({
									id:Math.random(),
									x:-1000,
									y:-1000,
									w:32,
									h:32,
									sw:32,
									sh:32,
									velocity:{x:(Math.random()*(2-1)+1),y:((4))},
									angle:_angle,
									dx:(ii*32),
									dy:128,
									delay:i === 0 ? 0 : Math.round(i/20)
								}));

								ii++;
								if(ii >= 4)ii=0;
							}
						};


						Gun.prototype.switchMuzzle=function(_e,_override){
							if(!_override&&this.currentState === _e)return;

							this.currentState = _e;
							this.currentFrameX = this.currentState.start.x;
							this.currentFrameY = this.currentState.end.x;
							this.maxFrameX = this.currentState.start.y;
							this.maxFrameY = this.currentState.end.y;
							this.frameDelay = 0;
						};	

						Gun.prototype.animate=function(){
							if(this.frameDelay++ > this.frameDelayAmount)
							{
								this.frameDelay = 0;
								this.currentFrameX++;
								if(this.currentFrameX >= this.maxFrameX)
								{	
									this.currentFrameX = this.currentState.start.x;
								}
							}
						}

						Gun.prototype.Restart=function(){
							this.notinuse=true;
							this.switchMuzzle(Gun.MUZZLES[this.type].IDLE);
							for(var i=0, len = this.particles.length;i<len;i++){this.particles[i].Restart();}
						};
						Gun.prototype.Update=function(){
							this.position.x = g_Player.position.x+this.offset.x;
							this.position.y = g_Player.position.y+this.offset.y;

							for(var i = 0, len = this.particles.length; i < len; i++){
									this.particles[i].Update();
								}

						};
						Gun.prototype.Render=function(){
							for(var i = 0, len = this.particles.length; i < len; i++){
								this.particles[i].Render();
							}
						};;
								function MachineGun(_opts){
							Gun.call(this, _opts);
						};
						MachineGun.prototype = Object.create(Gun.prototype);
						MachineGun.prototype.constructor=MachineGun;
						MachineGun.prototype.parent = Gun.prototype;

						MachineGun.prototype.Render=function(){
							if(!Arena.spriteSheets['guns'].machinegun.spritesLoaded || this.notinuse)return false;

							this.parent.Render.call(this);
							
							this.inView = true;
							ctx.drawImage(Arena.spriteSheets['guns'].machinegun.img, this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x, this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);


							if(!Arena.spriteSheets['muzzles'].spritesLoaded || this.notinuse)return false;
							this.animate();
							ctx.drawImage(Arena.spriteSheets['muzzles'].img, ((this.currentState.size.x)*this.currentFrameX)+this.currentState.offset.x,((this.currentState.size.y)*this.currentFrameY)+this.currentState.offset.y,this.currentState.size.x,this.currentState.size.y, (this.position.x+this.size.x+this.currentState.moffset.x) - g_Level.viewport.x - g_Level.shakeViewport.x, (this.position.y+this.currentState.moffset.y) - g_Level.viewport.y - g_Level.shakeViewport.y, this.currentState.size.x,this.currentState.size.y);
						};;
								function Bazooka(_opts){
							Gun.call(this, _opts);
						};
						Bazooka.prototype = Object.create(Gun.prototype);
						Bazooka.prototype.constructor=Bazooka;
						Bazooka.prototype.parent = Gun.prototype;

						Bazooka.prototype.Render=function(){

							if(!Arena.spriteSheets['guns'].bazooka.spritesLoaded || this.notinuse)return false;

							this.parent.Render.call(this);
							
							this.inView = true;
							ctx.drawImage(Arena.spriteSheets['guns'].bazooka.img, this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x, this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);

						};
								function Bullet(_opts){
							var self = this;
							this._id = _opts.id || null;
							this.position = new Vector(_opts.x || 0,_opts.y || 0);
							this.size = new Vector(_opts.w || 0, _opts.h || 0);
							this.bbox = new Vector(_opts.bx || _opts.w, _opts.by || _opts.h);
							this.velocity = new Vector(_opts.velocity.x,_opts.velocity.y);
							this.inView = true;
							this.collision = true;
							this.dead = true;
							this.type = this.constructor.name;
							this.layer = 2;
							this.strength = 0;
							this.items = [];
						};

						Bullet.prototype.Render=function(){
							if(!Arena.spriteSheets['bullets'][this.type].spritesLoaded || this.dead)return false;
							this.inView = true;

							//put in render function here!
							ctx.drawImage(Arena.spriteSheets['bullets'][this.type].img, this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x, this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						};

						Bullet.prototype.checkCollision=function(_cp){

							this.items = g_QuadTree.retrieve(this);

							for(var i = 0, len = this.items.length; i < len; i++){
								if(!this.items[i].inView)continue;
								if(boundingBoxCollision(this,this.items[i],_cp)){
									if(this.items[i].layer===5 || this.type==='GunBullet'&&this.items[i].layer!==11/*11 = enemies*/ ){continue;} //5 = roadbottom
									this.items[i].Trigger(this);
									if(this.type!=='BazookaBullet')return true;
								}
							};
							return false;

						};
						Bullet.prototype.Restart=function(){
							this.Die();
						};
						Bullet.prototype.Alive=function(_cp){
							this.position.x = _cp.x;
							this.position.y = _cp.y;
							this.dead = false;
							this.collision = true;
							this.inView = true;
						};
						Bullet.prototype.Die=function(){
							this.dead=true;
							this.collision = false;
							this.inView = false;
							this.position.x = -1000;
							this.position.y = -1000;
						};
						Bullet.prototype.Update=function(){
							if(this.dead)return false;
							if((this.position.x-g_Level.viewport.x) > playWidth || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)<= 0 || (this.position.y >= playHeight+g_Level.viewport.y+256)){this.Die(); return;}
							var speed =  Math.ceil((this.velocity.x));
							for(var i = 0; i < speed; i++){
								if(this.checkCollision({x:(this.position.x + 1),y:this.position.y,side:Character.DIRECTIONS.RIGHT})){
									if(this.type!=='BazookaBullet')this.Die();
								}
								this.position.x ++;
							}
						};;
								function GunBullet(_opts){
							Bullet.call(this, _opts);
							this.strength = 50;
						};
						GunBullet.prototype = Object.create(Bullet.prototype);
						GunBullet.prototype.constructor=GunBullet;
						GunBullet.prototype.parent = Bullet.prototype;;
								function BazookaBullet(_opts){
							Bullet.call(this, _opts);
							this.strength = 80;
						};
						BazookaBullet.prototype = Object.create(Bullet.prototype);
						BazookaBullet.prototype.constructor=BazookaBullet;
						BazookaBullet.prototype.parent = Bullet.prototype;
						;
								
						function Character(_opts){
							var self = this;
							this._id = _opts.id || null;
							
							this.position = new Vector(_opts.x || 0,_opts.y || 0);
							this.size = new Vector(_opts.w || 0, _opts.h || 0);
							this.srcsize = new Vector(_opts.sw || 0, _opts.sh || 0);
							this.bbox = new Vector(_opts.bx || _opts.w, _opts.by || _opts.h);
							this.velocity = new Vector(_opts.velocity.x,_opts.velocity.y);
							this.initialVelocity = new Vector(_opts.velocity.x,_opts.velocity.y);
							this.evilPosition = new Vector(0,0);
							this.inView = true;
							this.collision = true;
							this.isJumping = false;
							this.isDoubleJump = false;

							this.isGrounded = false;
							this.isRunning=_opts.running || false;
							this.dead = false;

							this.type = this.constructor.name;
							this.offset = _opts.offset || 0;
							this.frameDelay = 0;
							/*this.frameDelayAmount = 3;*/

							/*this.oldState = _opts.state;*/
							this.currentState = _opts.state;
							this.currentFrameX = this.currentState.start.x;
							this.currentFrameY = this.currentState.end.x;
							this.maxFrameX = this.currentState.start.y;
							this.maxFrameY = this.currentState.end.y;

							this.direction = Character.DIRECTIONS.RIGHT;
							this.health = 100;
							this.maxhealth = 100;
							this.speedBoost = false;
							this.powerUpState = Character.POWERUPS[this.type].DEFAULT;
							this.layer = 1;
							this.isEvil = false;
							this.isHit = false;
							this.particles = [];

							this.tempW = this.size.x;
							this.tempSrcX = this.srcsize.x;

							this.srcImageWidth = 0;
							this.imageWidth = 0;

							this.items = [];

							this.createParticles();

						};
						/*
						==========
						STATIC
						==========
						*/
						Character.gravity = 0.1;
						Character.offset = 8;
						Character.states = {
							Player:{
								DEFAULT:{start:{x:0, y:0}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:(32*4),y:0}, name:'DEFAULT', frameDelayAmount:3},
								IDLE:{start:{x:0, y:0}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:(32*4),y:0}, name:'IDLE', frameDelayAmount:3},
								RUNNING:{start:{x:0, y:2}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:0,y:0}, name:'RUNNING', frameDelayAmount:3},
								
								RUNNINGBAZOOKA:{start:{x:0, y:2}/*CURFRAMEX*/, end:{x:0,y:0}/*CURFRAMEY*/,bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:64,y:0}, name:'RUNNING BAZOOKA', frameDelayAmount:3},
								
								JUMPING:{start:{x:1, y:1}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:32,y:0}, name:'JUMPING', frameDelayAmount:3},
								FALLING:{start:{x:1, y:1}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:32,y:0}, name:'FALLING', frameDelayAmount:3},
								DEAD:{start:{x:1, y:0}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:0,y:0}, frameDelayAmount:3},
								SHOOT:{start:{x:1, y:0}, end:{x:0,y:0}, bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:32,y:0}, frameDelayAmount:3},
								BIKE:{start:{x:0, y:0}, end:{x:0,y:0}, bx:32,by:32,sw:54,sh:41,w:54,h:41,offset:{x:160,y:0}, frameDelayAmount:3}
							},
							Deer:{
								DEFAULT:{start:{x:0, y:0}, end:{x:0,y:0},bx:45,by:43,sw:45,sh:43,w:45,h:43,offset:{x:0,y:32}, frameDelayAmount:3},
								IDLE:{start:{x:0, y:0}, end:{x:0,y:0},bx:45,by:43,sw:45,sh:43,w:45,h:43,offset:{x:0,y:32}, frameDelayAmount:3},
								RUNNING:{start:{x:0, y:2}, end:{x:0,y:0},bx:45,by:43,sw:45,sh:43,w:45,h:43,offset:{x:45,y:32}, frameDelayAmount:4,dimensions:{0:{bx:45,by:43,sw:45,sh:43,w:45,h:43},1:{bx:55,by:43,sw:55,sh:43,w:55,h:43}}},
								DEAD:{start:{x:0, y:0}, end:{x:0,y:0},bx:45,by:43,sw:45,sh:43,w:45,h:43,offset:{x:0,y:32}, frameDelayAmount:3},
								JUMPING:{start:{x:0, y:0}, end:{x:0,y:0},bx:45,by:43,sw:45,sh:43,w:45,h:43,offset:{x:45,y:32}, frameDelayAmount:3},
								FALLING:{start:{x:0, y:0}, end:{x:0,y:0},bx:45,by:43,sw:45,sh:43,w:45,h:43,offset:{x:45,y:32}, frameDelayAmount:3}
							},
							Elf:{
								DEFAULT:{start:{x:0, y:0}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:0,y:96}, frameDelayAmount:3},
								IDLE:{start:{x:0, y:0}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:0,y:96}, frameDelayAmount:3},
								RUNNING:{start:{x:0, y:3}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:32,y:96}, frameDelayAmount:3},
								DEAD:{start:{x:1, y:0}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:0,y:96}, frameDelayAmount:3},
								JUMPING:{start:{x:0, y:0}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:64,y:96}, frameDelayAmount:3},
								FALLING:{start:{x:0, y:0}, end:{x:0,y:0},bx:32,by:32,sw:32,sh:32,w:32,h:32,offset:{x:64,y:96}, frameDelayAmount:3}
							}
						};


						/*RUNNING:{
									start:{x:0, y:2}, 
									end:{x:0,y:0},
									dimensions:{0:{bx:45,by:43,sw:45,sh:43,w:45,h:43},1:{bx:55,by:43,sw:55,sh:43,w:55,h:43}}
									offset:{
										0:{x:45,y:32},
										1:{x:45,y:32}
									}
								},*/



						Character.DIRECTIONS = {
							LEFT:0,
							RIGHT:1,
							UP:2,
							DOWN:3
						};
						Character.ENEMYLOGIC = {
							JUMP:0,
							INVULNERABLE:1
						};

						Character.GUNS = {
							machinegun:{obj:null,id:1},
							bazooka:{obj:null,id:2}
						};
						Character.POWERUPS = {
							Player:{
								BIKE:{
									id:1,
									Action:function(obj){
										obj.switchState(Character.states[obj.type].BIKE);
										obj.speedBoost = true;
										obj.powerUpState = Character.POWERUPS.Player.BIKE;
										obj.initialVelocity.x = obj.velocity.x; obj.initialVelocity.y = obj.velocity.y;
										obj.velocity.x = obj.velocity.x + 10;
									},
									Update:function(obj){
										obj.velocity.x -= 1 * g_Utilities.delta;
										g_Level.decreaseEvilViewport();

										if(obj.velocity.x <= obj.initialVelocity.x){
											obj.speedBoost = false;
											obj.switchState(Character.states[obj.type].RUNNING);
											obj.powerUpState = Character.POWERUPS.Player.DEFAULT;
											obj.velocity.x = obj.initialVelocity.x; obj.velocity.y = obj.initialVelocity.y;
										}
									}
								},
								BAZOOKA:{
									Action:function(obj){
										obj.AddBazookaToInventory();
										//DONT NEED THIS AS IT DOESNT REQUIRE AN UPDATE!//obj.powerUpState = Character.POWERUPS.Player.BAZOOKA;
									}
								},
								BOOZE:{
									Action:function(obj){
										obj.increaseHealth(20);
									}
								},
								DEFAULT:{
									id:0
								}
							},
							Deer:{
								DEFAULT:{
									id:0
								}
							},
							Elf:{
								DEFAULT:{
									id:0
								}
							}
						};

						Character.getBestSpawnPoint=function(obj, _inc){
							for(var i = 0, len=g_Level.levels[g_Level.currentLevel].collectableSpawnPoints.length; i < len; i++){
								if(g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].x >= obj.position.x+(playWidth/2)){
									i = i + _inc;
									if(i >= g_Level.levels[g_Level.currentLevel].collectableSpawnPoints.length)i = g_Level.levels[g_Level.currentLevel].collectableSpawnPoints.length-1;
									return g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i];
								};
							};
							return {x:obj.position.x, y:obj.position.y};
						};
						Character.RandomEnemy=function(){
							return (Math.round(Math.random() * (1))) === 0 ? new Deer({x:-1000,y:-1000}) : new Elf({x:-1000,y:-1000});
						}

						/*
						==========
						VARIABLES
						==========
						*/


						/*
						========
						FUNCS
						========
						*/
						Character.prototype.Restart=function(){
							this.isJumping = false;
							this.isDoubleJump = false;
							this.isGrounded = false;
							/*this.frameDelayAmount = this.currentState.frameDelayAmount;*/
							this.direction = Character.DIRECTIONS.RIGHT;
							this.dead = !1;
							this.health = 100;
							this.speedBoost = false;
							this.powerUpState = Character.POWERUPS[this.type].DEFAULT;
							this.collision = true;
							for(var i=0, len = this.particles.length;i<len;i++){this.particles[i].Restart();}
						}

						Character.prototype.switchState=function(_e,_override){
							if(!_override&&this.currentState === _e || !_override&&this.currentState===Character.states[this.type].DEAD)return;
							// this.oldState = this.currentState;
							this.currentState = _e;
							this.currentFrameX = this.currentState.start.x;
							this.currentFrameY = this.currentState.end.x;
							this.maxFrameX = this.currentState.start.y;
							this.maxFrameY = this.currentState.end.y;

							this.bbox.x = this.currentState.bx;
							this.bbox.y = this.currentState.bx;
							this.srcsize.x = this.currentState.sw;
							this.srcsize.y = this.currentState.sh;
							this.size.x = this.currentState.w;
							this.size.y = this.currentState.h;
							this.frameDelay = 0;
						};	
						Character.prototype.animate=function(){
							if(this.frameDelay++ > /*this.frameDelayAmount*/this.currentState.frameDelayAmount)
							{
								this.frameDelay = 0;
								this.currentFrameX++;
								if(this.currentFrameX >= this.maxFrameX)
								{	
									this.currentFrameX = this.currentState.start.x;
								}
							}
						}
						Character.prototype.checkCollision=function(_cp){
							
							this.items = g_QuadTree.retrieve(this);
							
							for(var i = 0, len = this.items.length; i < len; i++){
								
								if(this.type==='Deer'&&this.items[i].enemylayer!==10 || this.type==='Elf'&&this.items[i].enemylayer!==10)continue;

								if(boundingBoxCollision(this,this.items[i],_cp)){
									if(this.type==='Player'&&!this.speedBoost || this.type==='Elf' || this.type==='Deer')this.items[i].Trigger(this,{direction:_cp.side});
									if(this.items[i].type!=='Deer'&&this.items[i].type!=='Elf'&&this.type==='Player'&&this.items[i].layer!==12 || this.type!=='Player')return (this.items[i]);
								}
							};
							return false;
						};
						Character.prototype.Jump=function(){
							if(this.dead || this.isDoubleJump)return;
							
							sounds.jump.play();

							if(this.isJumping)this.isDoubleJump = true;
							
							this.isJumping = true;
							
							if(!this.speedBoost)this.switchState(Character.states[this.type].JUMPING);
							if(this.isGrounded)this.velocity.y = 3.5;
							if(this.isDoubleJump){ this.velocity.y = 3.5; }
							this.isGrounded = false;
						};
						Character.prototype.Fall=function(){
							if(!this.speedBoost)this.switchState(Character.states[this.type].FALLING);
						}
						Character.prototype.Update=function(){
							if(this.dead)return false;

							if((((this.position.x+this.size.x)-g_Level.viewport.x) <= 0) || ((this.position.x)-g_Level.viewport.x) >= (playWidth+Arena.TILESIZE) ){this.inView=false; this.collision = false; return false;}
							if(!this.inView)this.inView = true;
							if(!this.collision)this.collision=true;

							this.Gravity();
						};
						Character.prototype.Dead=function(){
							this.collision = false;
							this.dead=!0;
							this.isJumping=false;
							this.velocity.y = 0;
							for(var i = 0, len = this.particles.length; i < len; i++){
								this.particles[i].Alive({x:(this.position.x+(this.size.x/2)), y:(this.position.y+(this.size.y/2))});
							}
						};
						Character.prototype.Gravity=function(){
							this.velocity.y -= Character.gravity;
							if(this.velocity.y <= 0){
								if(!this.isGrounded)this.Fall();
								this.Down(this.velocity.y*-1);
							}else{
								this.Up(this.velocity.y);
							}
							return;
						};	
						Character.prototype.Up=function(_vel){
							var speed = Math.ceil(_vel);

							for(var i = 0; i < speed; i++){
								var _c = this.checkCollision({x:this.position.x,y:(this.position.y-1), side:Character.DIRECTIONS.UP});
								if(_c){
									/*_c.Trigger(this,{direction:Character.DIRECTIONS.UP});*/
									if(_c.layer!==12&&this.type==='Player'&&_c.type!=='Deer'&&_c.type!=='Elf' || this.type==='Deer' || this.type==='Elf'){
										this.velocity.y = 0; 
										break;
									}
								}

								if(this.type==='Player'){ g_Level.UpdateViewport();/*if(g_Level.isYCenter(this.position.y))g_Level.decY()*/ }
								this.position.y --;
							}	
						};
						Character.prototype.Down=function(_vel){
							var speed = Math.ceil(_vel);

							for(var i = 0; i < speed; i++){
								var _c = this.checkCollision({x:this.position.x,y:(this.position.y+1), side:Character.DIRECTIONS.DOWN});
								if(_c){		
									/*_c.Trigger(this,{direction:Character.DIRECTIONS.DOWN});*/
									if(_c.layer!==12&&this.type==='Player'&&_c.type!=='Deer'&&_c.type!=='Elf' || this.type==='Deer' || this.type==='Elf'){
										this.isGrounded=true; this.isJumping = false; this.isDoubleJump = false; this.velocity.y = 0;
										break;
									}
								}
								this.isGrounded = false;
								if(this.type==='Player'){ g_Level.UpdateViewport(); /*if(g_Level.isYCenter(this.position.y))g_Level.incY()*/ }
								this.position.y ++;
							}	
						};
						Character.prototype.Render=function(){
							if(!Arena.spriteSheets['charactergood'] || !Arena.spriteSheets['charactergood'].img || !Arena.spriteSheets['charactergood'].spritesLoaded || !this.inView || this.dead){return false;}
							
							this.animate();

							this.tempW = this.currentState.dimensions ? this.currentState.dimensions[this.currentFrameX].sw : this.size.x;
							this.tempSrcX = this.currentState.dimensions ? this.currentState.dimensions[this.currentFrameX].w : this.srcsize.x;


							if(!this.isEvil || this.type==='Player'){ ctx.drawImage(Arena.spriteSheets['charactergood'].img,((this.srcsize.x)*this.currentFrameX)+this.currentState.offset.x,((this.srcsize.y)*this.currentFrameY)+this.currentState.offset.y,this.tempSrcX,this.srcsize.y, (this.position.x - g_Level.viewport.x | 0) - g_Level.shakeViewport.x, (this.position.y - g_Level.viewport.y | 0) - g_Level.shakeViewport.y, this.tempW, this.size.y); return; }

							if(!Arena.spriteSheets['characterbad'] || !Arena.spriteSheets['characterbad'].img || !Arena.spriteSheets['characterbad'].spritesLoaded){return false;}

							this.evilPosition.x = (((g_Level.evilViewport.x)) - ((this.position.x) - g_Level.viewport.x));

							if(this.evilPosition.x >= this.tempW)this.evilPosition.x = this.tempW;
							

							this.srcImageWidth = (this.tempSrcX-this.evilPosition.x);
							this.imageWidth = (this.tempW-this.evilPosition.x);
							
							if(this.imageWidth&&this.srcImageWidth)ctx.drawImage(Arena.spriteSheets['charactergood'].img,(((this.srcsize.x)*this.currentFrameX)+this.currentState.offset.x)+this.evilPosition.x,((this.srcsize.y)*this.currentFrameY)+this.currentState.offset.y,this.srcImageWidth,this.srcsize.y, ((this.position.x+this.evilPosition.x) - g_Level.viewport.x | 0) - g_Level.shakeViewport.x, (this.position.y - g_Level.viewport.y | 0) - g_Level.shakeViewport.y, this.imageWidth, this.size.y);	
							if(this.evilPosition.x)ctx.drawImage(Arena.spriteSheets['characterbad'].img, ((this.srcsize.x)*this.currentFrameX)+this.currentState.offset.x , ((this.srcsize.y)*this.currentFrameY)+this.currentState.offset.y , this.evilPosition.x ,this.size.y, (this.position.x - g_Level.viewport.x | 0) - g_Level.shakeViewport.x, (this.position.y - g_Level.viewport.y | 0) - g_Level.shakeViewport.y, this.evilPosition.x,this.size.y);
							

						};
						Character.prototype.Trigger=function(obj){
							if(obj.type==='GunBullet'){
								this.health -= obj.strength;
							}else
							if(obj.type==='BazookaBullet'){
								this.health -= obj.strength;
							}else
							if(obj.type==='Deer'){
								this.health -= obj.strength;
							}else
							if(obj.type==='Elf'){
								this.health -= obj.strength;
							}else
							if(obj.type==='Arena'){
								this.health -= obj.evilStrength;
							}

						};
						Character.prototype.evilWorld=function(){
							this.isEvil = ((g_Level.evilViewport.x)) < ((this.position.x) - g_Level.viewport.x) ? false : ((this.position.x-g_Level.viewport.x) > playWidth || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight+g_Level.viewport.y)) ? false : true;
						};

						Character.prototype.Spawn=function(_offset){
							
							for(var i = 0, len=g_Level.levels[g_Level.currentLevel].enemySpawnPoints.length; i < len; i++){
								if((g_Level.levels[g_Level.currentLevel].enemySpawnPoints[i].x + _offset) - g_Level.viewport.x >= playWidth){
									this.dead = false;
									this.health = this.maxhealth;
									this.hitPlayer = false;
									this.position.x = (g_Level.levels[g_Level.currentLevel].enemySpawnPoints[i].x + _offset) - (Math.abs(this.size.x-g_Level.levels[g_Level.currentLevel].enemySpawnPoints[i].w));
									this.position.y = g_Level.levels[g_Level.currentLevel].enemySpawnPoints[i].y - (Math.abs(this.size.y-g_Level.levels[g_Level.currentLevel].enemySpawnPoints[i].h));
									this.velocity.x = Math.random() * ((g_Player.velocity.x+1)-g_Player.velocity.x)+g_Player.velocity.x >> 0;

									break;
								}
							}

						};

						Character.prototype.createParticles=function(){

							for(var i = 0; i < 100; i++){
								var _angle = (Math.random() * (360)) >> 0;
								this.particles.push(new BloodParticle({
									id:Math.random(),
									x:-1000,
									y:-1000,
									w:5,
									h:5,
									sw:10,
									sh:10,
									velocity:{x:(Math.random()*(5-1)+1),y:(Math.random()*(5-1)+1)},
									angle:_angle,
									dx:((Math.random()*20) >> 0),
									dy:((Math.random()*20) >> 0),
									delay:i === 0 ? 0 : Math.round(i/100)
								}));
							}
							for(var i = 0; i < 8; i++){
								var _angle = (Math.random() * (360)) >> 0;
								this.particles.push(new CharacterParticle({
									id:Math.random(),
									x:-1000,
									y:-1000,
									w:32,
									h:32,
									sw:32,
									sh:32,
									velocity:{x:(Math.random()*(5-2)+2),y:((5))},
									angle:_angle,
									dx:(i*32),
									dy:this.type==='Deer' ? 96 : this.type==='Elf' ? 64 : 32 ,
									delay:i === 0 ? 0 : Math.round(i/8)
								}));
							};
						};

						Character.prototype.increaseHealth=function(_amount){
							this.health += _amount;
							if(this.health >= this.maxhealth)this.health = this.maxhealth;
						}; ;
								function Player(){
							Character.call(this, {
								id:Math.random(),
								x:32,
								y:g_Level.levels[g_Level.currentLevel].scrollHeight-(Arena.TILESIZE*2),
								w:32,
								h:32,
								bx:32,
								by:32,
								sw:32,
								sh:32,
								offset:0,
								velocity:new Vector(8,0),
								state:Character.states['Player'].DEFAULT,
								running:true
							});
							this.maxVelocity = new Vector(20,0);
							this.maxhealth = 100;
							this.gunbullets = [];
							this.bazookabullets = [];
							this.children = [];
							this.hasBazooka = false;
							this.currentGunBulletIndex = -1;
							this.currentBazookaBulletIndex = -1;
							this.createGuns();
							this.createBullets();

							this.changeWeapon(true);

							this.score = 0;
							this.currentDistance = 0;
							this.distance = 0;
							this.stepOffset = new Vector(80,0);

							this.checkstep = new Vector(this.position.x+this.stepOffset.x,0);

							this.canShoot = true;

							this.currentShootTimer = 0;
							this.currentShootAmount = 20;

							this.currentBikeTarget = {};

							//g_Level.centerView(this.position.x,this.position.y);


						};

						Player.prototype = Object.create(Character.prototype);
						Player.prototype.constructor=Player;
						Player.prototype.parent = Character.prototype;

						Player.gameoverText = 'Tap to play again!';
						Player.gameoverOpacity = 0;

						Player.prototype.createGuns=function(){
							this.children.push(new MachineGun({
								id:Math.random(),
								x:this.position.x+12,
								y:this.position.y+(this.size.y/2),
								w:32,
								h:17,
								velocity:{x:0,y:0},
								notinuse:false,
								offset:{x:8,y:(this.size.y/2)},
								mw:8,
								mh:15
							}));
							Character.GUNS['machinegun'].obj = this.children[this.children.length-1];

							this.children.push(new Bazooka({
								id:Math.random(),
								x:this.position.x,
								y:this.position.y,
								w:32,
								h:17,
								velocity:{x:0,y:1},
								notinuse:true,
								offset:{x:3,y:0},
								mw:8,
								mh:15
							}));
							Character.GUNS['bazooka'].obj = this.children[this.children.length-1];

							this.currentGun = Character.GUNS['machinegun'];
							return true;
						};
						Player.prototype.createBullets=function(){
							for(var i = 0; i < 30; i++){
								this.gunbullets.push(new GunBullet({
									id:Math.random(),
									x:-1000,
									y:-1000,
									w:10,
									h:10,
									bx:10,
									by:10,
									velocity:{x:10,y:0}
								}));
								this.children.push(this.gunbullets[this.gunbullets.length-1]);
							}
							for(var i = 0; i < 5; i++){
								this.bazookabullets.push(new BazookaBullet({
									id:Math.random(),
									x:-1000,
									y:-1000,
									w:17,
									h:15,
									bx:17,
									by:15,
									velocity:{x:10,y:0}
								}));

								this.children.push(this.bazookabullets[this.bazookabullets.length-1]);
							}
						};

						Player.prototype.Shoot=function(){
							if(!this.canShoot)return false;

							this.canShoot = false;

							switch(this.currentGun){
								case Character.GUNS['machinegun']:
									if(this.currentGunBulletIndex++ >= this.gunbullets.length-1)this.currentGunBulletIndex=0;
									this.gunbullets[this.currentGunBulletIndex].Alive({x:((this.position.x)+(this.bbox.x/2)), y:((this.position.y)+(this.bbox.y/4)+9) });
									sounds.gun.play();
									this.currentGun.obj.switchMuzzle(Gun.MUZZLES[this.currentGun.obj.type].FIRE);
									this.currentGun.obj.Shoot();
								break;

								case Character.GUNS['bazooka']:
									if(this.currentBazookaBulletIndex++ >= this.bazookabullets.length-1){this.RemoveBazookaFromInventory();}
									this.bazookabullets[this.currentBazookaBulletIndex].Alive({x:((this.position.x)+(this.bbox.x/2)), y:((this.position.y)+(this.bbox.y/4)-8) });
									sounds.bazooka.play();
									this.currentGun.obj.switchMuzzle(Gun.MUZZLES[this.currentGun.obj.type].FIRE);
									this.currentGun.obj.Shoot();
								break;
							}
						};
						Player.prototype.StopShoot=function(){
							this.currentGun.obj.switchMuzzle(Gun.MUZZLES[this.currentGun.obj.type].IDLE);
						};

						Player.prototype.RemoveBazookaFromInventory=function(){
							this.currentBazookaBulletIndex=0;
							this.hasBazooka = false;
							this.changeWeapon(true);
						};
						Player.prototype.AddBazookaToInventory=function(){
							this.hasBazooka = true;
							this.currentBazookaBulletIndex = 0;
						};
						Player.prototype.changeWeapon=function(_arg){
							if(_arg&&typeof(_arg)==='string'){
								_arg = _arg==='bazooka' ? this.hasBazooka ? 'bazooka' : 'machinegun' : 'machinegun';
								this.currentGun.obj.notinuse = true;
								this.currentGun = Character.GUNS[_arg];
								this.currentGun.obj.notinuse = false;
								return;
							

							}else
							if(_arg&&typeof(_arg)==='boolean'){
								this.currentGun.obj.notinuse = true;
								this.currentGun = this.currentGun === Character.GUNS['machinegun'] ? this.hasBazooka ? Character.GUNS['bazooka'] : Character.GUNS['machinegun'] : Character.GUNS['machinegun'];
								this.currentGun.obj.notinuse = false;
								return;
							}
						};

						Player.prototype.Restart=function(){
							this.position.x = 32;
							this.position.y = g_Level.levels[g_Level.currentLevel].scrollHeight-(Arena.TILESIZE*2);
							this.velocity.x = 8;
							this.velocity.y = 0;
							this.isRunning = true;
							/*this.oldState = Character.states['Player'].DEFAULT;*/
							this.switchState(Character.states['Player'].DEFAULT,true);
							this.score = 0;
							this.distance = 0;
							this.currentDistance = 0;
							this.currentGunBulletIndex = 0;
							this.currentBazookaBulletIndex = 0;
							this.hasBazooka = false;
							this.checkstep.x = this.position.x+this.stepOffset.x; this.checkstep.y = 0;
							this.currentShootTimer = 0;

							Player.gameoverOpacity = 0;
							for(var i=0, len = this.children.length;i<len;i++){this.children[i].Restart();}
							g_Level.centerView(this.position.x,this.position.y);
							
							this.changeWeapon(true);
							this.currentGun.obj.Update(0);

							this.canShoot = true;

							this.parent.Restart.call(this);

							this.Render();
						}

						Player.prototype.checkSteps=function(){

							/* PLEASE REMOVE THIS AS ITS ONLY TEMPORARY TO TEST RECURSIN OF MAP! */
							//if(this.position.x >= scrollWidth){this.position.x = 171; this.position.y = 864; this.checkstep.x = this.position.x; g_Level.centerView(this.position.x,this.position.y);}
							/*END HERE */

							if(this.position.x >= g_Level.levels[g_Level.currentLevel].scrollWidth){
								g_Level.changeLevel();
							};


							if(this.position.x < this.checkstep.x)return false;
							this.checkstep.x = this.position.x + this.stepOffset.x;
							g_Level.releaseTheHounds();
							g_Level.generateItems();
						};

						Player.prototype.Update=function(){
								
							this.evilWorld();

							if(this.dead===true){
								if(this.isGrounded){this.switchState(Character.states[this.type].DEAD);} 
								for(var i = 0, len = this.particles.length; i < len; i++){
									this.particles[i].Update();
								}
								return;
							}

							if(!debug)this.parent.Update.call(this);

							if(this.currentShootTimer ++ >= this.currentShootAmount){this.canShoot=true; this.currentShootTimer=0; }

							
							if(!debug)this.powerUpUpdate();

							var speed =  Math.ceil((this.velocity.x));
							
							if(debug===true){
								if(leftkey===true){

									for(var i = 0; i < speed; i++){
										if(!this.checkCollision({x:(this.position.x - 1),y:this.position.y,side:Character.DIRECTIONS.LEFT})){
											if(this.type==='Player'){ g_Level.UpdateViewport(); }
											this.position.x --;
										}
									}	

									
								} if(rightkey===true){

									for(var i = 0; i < speed; i++){
										if(!this.checkCollision({x:(this.position.x + 1),y:this.position.y,side:Character.DIRECTIONS.RIGHT})){
											if(this.type==='Player'){ g_Level.UpdateViewport(); }
											this.position.x ++;
										}
									}
									
								} if(upkey===true){
									
									for(var i = 0; i < speed; i++){

										if(this.checkCollision({x:this.position.x,y:(this.position.y-1), side:Character.DIRECTIONS.UP})){
											this.velocity.y = 0; return; 
										}
										if(this.type==='Player'){ g_Level.UpdateViewport(); }
										this.position.y --;
										
									}	

								
								} if(downkey===true){
									
									for(var i = 0; i < speed; i++){

										if(this.checkCollision({x:this.position.x,y:(this.position.y+1), side:Character.DIRECTIONS.DOWN})){
											this.isGrounded=true; this.velocity.y = 0; return; 
										}
										if(this.type==='Player'){ g_Level.UpdateViewport(); }
										this.position.y ++;
										
									}

								}
								return;
							}

							
								for(var i = 0, len = Math.floor(this.velocity.x); i < len; i++){
									var _c = this.checkCollision({x:(this.position.x + 1),y:this.position.y,side:Character.DIRECTIONS.RIGHT});
									if(_c){
										/*_c.Trigger(this,{direction:Character.DIRECTIONS.RIGHT});*/
										if(_c.type!=='Deer'&&_c.type!=='Elf'&&_c.layer!==12){ if(this.isGrounded){ if(!this.speedBoost){this.switchState(Character.states[this.type].IDLE);  this.isHit=true;} }  break; }
									};

									this.isHit=false;
									if(this.isGrounded&&!this.isHit&&!this.speedBoost){ if(this.currentGun===Character.GUNS['bazooka']){this.switchState(Character.states[this.type].RUNNINGBAZOOKA);}else{this.switchState(Character.states[this.type].RUNNING);} }
									/*if(g_Level.isXCenter(this.position.x >> 0))g_Level.incX();*/
									g_Level.UpdateViewport();
									this.position.x += 0.2;
									this.incDistance(0.2);
									this.checkSteps();
								};
							
								for(var i = 0, len = this.children.length; i < len; i++){
									this.children[i].Update();
								}

								
								
						};

						Player.prototype.incDistance=function(_amount){
							this.currentDistance += _amount;
							this.distance = Math.round(this.currentDistance/10);
						};

						Player.prototype.Render=function(){


							this.parent.Render.call(this);

							if(debug){
								ctx.strokeStyle='#ff0000';
								ctx.strokeRect(this.position.x-g_Level.viewport.x,this.position.y-g_Level.viewport.y,this.size.x,this.size.y);
							}

							if(!this.dead){
								for(var i = 0, len = this.children.length; i < len; i++){
									this.children[i].Render();
								}
							}

							if(!this.dead)return false;

							for(var i = 0, len = this.particles.length; i < len; i++){
								this.particles[i].Render();
							}

						};

						Player.prototype.Dead=function(){
							if(this.dead)return;
							this.parent.Dead.call(this);

							/*POST THERE SCORE*/
							GAME_HANDLER.PostScore();
							
						};
						Player.prototype.evilWorld=function(){
							this.parent.evilWorld.call(this);
						};
						Player.prototype.Trigger=function(obj){
							this.parent.Trigger.call(this, obj);
							if(this.health <= 0){this.health = 0; this.Dead();}
						};
						Player.prototype.powerUp=function(type){
							switch(type.id){
								case Character.POWERUPS.Player.BIKE.id:
									type.Action(this);
								break;
								case Character.POWERUPS.Player.BAZOOKA.id:
									type.Action(this);
								break;
							};
						};
						Player.prototype.powerUpUpdate=function(){
							switch(this.powerUpState.id){
								case Character.POWERUPS.Player.BIKE.id:
									this.powerUpState.Update(this);
								break;
							};
						}
						Player.prototype.increaseSpeed=function(){
							if(this.speedBoost)return true;
							if(this.velocity.x >= this.maxVelocity.x){this.velocity.x = this.maxVelocity.x; return false; }
							this.velocity.x ++;
						}; ;
								function Deer(_opts){
							Character.call(this, {
								id:Math.random(),
								x: _opts&&_opts.x || (Math.random() * (3000-512)+512),
								y: _opts&&_opts.y || 0,
								w:_opts&&_opts.w || 45,
								h:_opts&&_opts.h || 43,
								sw:_opts&&_opts.sw || 45,
								sh:_opts&&_opts.sh || 43,
								velocity:new Vector(_opts&&_opts.vx || 1, _opts&&_opts.vy || 0),
								state:Character.states['Deer'].DEFAULT,
							});
							this.layer = 11;
							this.health = 50;
							this.maxhealth = 50;
							this.hitPlayer = false;
							this.strength = 10;

							
							for(var i = 0, len = Object.keys(g_Level.levels).length; i < len; i++){
								g_Level.levels[i].collisionChildren.push(this);
							};
							
							//g_Level.collisionChildren.push(this);


						};
						Deer.prototype = Object.create(Character.prototype);
						Deer.prototype.constructor=Deer;
						Deer.prototype.parent = Character.prototype;

						Deer.prototype.Jump=function(_type){
							this.switchState(Character.states[this.type].JUMPING);
							this.velocity.y = _type ? 2 : 3;
						};


						Deer.prototype.Update=function(){
							this.parent.Update.call(this);
							
							if(!this.inView)return false;

							this.evilWorld();

							if(this.dead){
								for(var i = 0, len = this.particles.length; i < len; i++){
									this.particles[i].Update();
								}
							}

							if(debug || this.dead)return false;

							for(var i = 0, len = Math.floor(this.velocity.x); i < len; i++){
								if(!this.checkCollision({x:(this.position.x - 1),y:this.position.y,side:Character.DIRECTIONS.LEFT})){
									this.position.x -= 0.2; // -= 0.2
									this.switchState(Character.states[this.type].RUNNING);
								}else{
									this.Logic(Character.ENEMYLOGIC.JUMP);
									this.switchState(Character.states[this.type].JUMPING);
								}
							}
						};
						Deer.prototype.Render=function(){

							this.parent.Render.call(this);

							if(debug){
								ctx.strokeStyle='#ff0000';
								ctx.strokeRect(this.position.x-g_Level.viewport.x,this.position.y-g_Level.viewport.y,this.size.x,this.size.y);
							}

							if(!this.dead)return false;

							for(var i = 0, len = this.particles.length; i < len; i++){
								this.particles[i].Render();
							}


						};
						Deer.prototype.RandomLogicAttr=function(){
							return (Math.round(Math.random() * Object.keys(Character.ENEMYLOGIC).length-1));
						};
						Deer.prototype.Logic=function(type){
							switch(type || this.RandomLogicAttr()){

								case Character.ENEMYLOGIC.JUMP:
									this.Jump(type);
								break;

								case Character.ENEMYLOGIC.INVULNERABLE:
									//TODO: INVULNERABLE
								break;

								default:
								break;

							};
						};
						Deer.prototype.Restart=function(){
							this.hitPlayer = false;
							this.position.x = -1000;
							this.position.y = -1000;
							// this.oldState = Character.states['Deer'].DEFAULT;
							this.switchState(Character.states['Deer'].DEFAULT,true);
							this.velocity.x = 1;
							this.velocity.y = 0;
							this.parent.Restart.call(this);
							this.health = 50;
							this.Render();
						}
						Deer.prototype.evilWorld=function(){
							this.parent.evilWorld.call(this);
						};
						Deer.prototype.Dead=function(){
							this.parent.Dead.call(this);
						};	
						Deer.prototype.Trigger=function(obj){
							this.parent.Trigger.call(this, obj);

							if(obj.type==='Player'){
								if(this.hitPlayer){return true;}
								this.hitPlayer = true;
								g_Player.Trigger(this);
							}

							if(this.health <= 0)this.Dead();
						};;
								function Elf(_opts){
							Character.call(this, {
								id:Math.random(),
								x: _opts&&_opts.x || (Math.random() * (3000-512)+512),
								y: _opts&&_opts.y || 0,
								w:_opts&&_opts.w || 45,
								h:_opts&&_opts.h || 43,
								sw:_opts&&_opts.sw || 45,
								sh:_opts&&_opts.sh || 43,
								velocity:new Vector(_opts&&_opts.vx || 1, _opts&&_opts.vy || 0),
								state:Character.states['Elf'].DEFAULT,
							});
							this.layer = 11;
							this.health = 50;
							this.maxhealth = 50;
							this.hitPlayer = false;
							this.strength = 8;
							

							for(var i = 0, len = Object.keys(g_Level.levels).length; i < len; i++){
								g_Level.levels[i].collisionChildren.push(this);
							};
							//g_Level.collisionChildren.push(this);
						};
						Elf.prototype = Object.create(Character.prototype);
						Elf.prototype.constructor=Elf;
						Elf.prototype.parent = Character.prototype;

						/*Elf.prototype.createParticles=function(){

							for(var i = 0; i < 100; i++){
								var _angle = (Math.random() * (360)) >> 0;
								this.particles.push(new BloodParticle({
									id:Math.random(),
									x:-1000,
									y:-1000,
									w:5,
									h:5,
									sw:10,
									sh:10,
									velocity:{x:(Math.random()*(5-1)+1),y:(Math.random()*(5-1)+1)},
									angle:_angle,
									dx:((Math.random()*20) >> 0),
									dy:((Math.random()*20) >> 0),
									delay:i === 0 ? 0 : Math.round(i/100)
								}));
							}

							for(var i = 0; i < 8; i++){
								this.particles.push(new CharacterParticle({
									id:Math.random(),
									x:-1000,
									y:-1000,
									w:32,
									h:32,
									sw:32,
									sh:32,
									velocity:{x:(Math.random()*(5-1)+1),y:(Math.random()*(8-2)+2)},
									angle:_angle,
									dx:(i*32),
									dy:64,
									delay:i === 0 ? 0 : Math.round(i/8)
								}));
							};
						};	*/

						Elf.prototype.Jump=function(_type){
							this.switchState(Character.states[this.type].JUMPING);
							this.velocity.y = _type ? 2 : 3;
						};


						Elf.prototype.Update=function(){
							this.parent.Update.call(this);
							
							if(!this.inView)return false;

							this.evilWorld();

							if(this.dead){
								for(var i = 0, len = this.particles.length; i < len; i++){
									this.particles[i].Update();
								}
							}

							if(debug || this.dead)return false;

							//this.Logic();
							

							//var speed =  Math.ceil((this.velocity.x));
							for(var i = 0, len = Math.floor(this.velocity.x); i < len; i++){
								if(!this.checkCollision({x:(this.position.x - 1),y:this.position.y,side:Character.DIRECTIONS.LEFT})){
									this.position.x -= 0.2; //-= 0.2;
									this.switchState(Character.states[this.type].RUNNING);
								}else{
									this.Logic(Character.ENEMYLOGIC.JUMP);
									this.switchState(Character.states[this.type].JUMPING);
								}
							}
						};
						Elf.prototype.Render=function(){

							this.parent.Render.call(this);

							if(debug){
								ctx.strokeStyle='#ff0000';
								ctx.strokeRect(this.position.x-g_Level.viewport.x,this.position.y-g_Level.viewport.y,this.size.x,this.size.y);
							}
							
							if(!this.dead)return false;

							for(var i = 0, len = this.particles.length; i < len; i++){
								this.particles[i].Render();
							}
						};
						Elf.prototype.RandomLogicAttr=function(){
							return (Math.round(Math.random() * Object.keys(Character.ENEMYLOGIC).length-1));
						};
						Elf.prototype.Logic=function(type){
							switch(type || this.RandomLogicAttr()){

								case Character.ENEMYLOGIC.JUMP:
									this.Jump(type);
								break;

								case Character.ENEMYLOGIC.INVULNERABLE:
									//TODO: INVULNERABLE
								break;

								default:
								break;

							};
						};
						Elf.prototype.Restart=function(){
							this.hitPlayer = false;
							this.position.x = -1000;
							this.position.y = -1000;
							this.switchState(Character.states['Elf'].DEFAULT,true);
							this.velocity.x = 1;
							this.velocity.y = 0;
							
							this.parent.Restart.call(this);

							this.health = 50;

							this.Render();
						}
						Elf.prototype.evilWorld=function(){
							this.parent.evilWorld.call(this);
						};
						Elf.prototype.Dead=function(){
							this.parent.Dead.call(this);
						};	
						Elf.prototype.Trigger=function(obj){
							this.parent.Trigger.call(this, obj);

							if(obj.type==='Player'){
								if(this.hitPlayer){return true;}
								this.hitPlayer = true;
								g_Player.Trigger(this);
							}

							if(this.health <= 0)this.Dead();
						};;
								function Snow(_opts){

							this.position = new Vector(_opts&&_opts.x || 0, _opts&&_opts.y || 0);
							this.size = new Vector(_opts&&_opts.w || playWidth, _opts&&_opts.h || 60);
							this.dest = new Vector(_opts&&_opts.dx || 0, _opts&&_opts.dy || 0);
							this.delay = _opts&&_opts.delay || 0;
							this.yTimer = 0;
						};

						Snow.prototype.Render=function(){
							if(!Arena.spriteSheets['snow'].img || !Arena.spriteSheets['snow'].spritesLoaded)return false;

							var pX = (g_Level.viewport.x % (playWidth / this.delay)) * this.delay; 
							for(var x = 0; x < (playWidth/playWidth) + 1; x++){
								ctx.drawImage(Arena.spriteSheets['snow'].img, 0 , 0 , playWidth ,Arena.spriteSheets['snow'].img.height, (x*playWidth) - pX,0 , playWidth,Arena.spriteSheets['snow'].img.height);
							}

						};;
								function Powerup(_opts){

							this.position = new Vector( _opts&&_opts.x || 0, _opts&& _opts.y || 0);
							//this.staticPosition = new Vector(this.position.x, this.position.y);

							this.size = new Vector( _opts&&_opts.w || 0,  _opts&&_opts.h || 0);
							this.bbox = new Vector( _opts&&_opts.bx ||  _opts&&_opts.w,  _opts&&_opts.by ||  _opts&&_opts.h);
							this.dest = new Vector( _opts&&_opts.dx || 0,  _opts&&_opts.dy || 0);
							this.inView = false;
							this.collision = _opts&&_opts.collision || false;
							this.type = this.constructor.name;
							this.layer = 12;
							this.active = false;
							this.isFg = _opts.isFg;
						};

						Powerup.prototype.Restart=function(){
							this.Die();
						}
						Powerup.prototype.Die=function(){
							this.collision = false;
							this.inView = false;
							this.active = false;
						};
						Powerup.prototype.Render=function(){
							if(!Arena.spriteSheets['goodtiles'] || !Arena.spriteSheets['goodtiles'].img || !Arena.spriteSheets['goodtiles'].spritesLoaded || !this.inView || !this.active )return false;
							ctx.drawImage(Arena.spriteSheets['goodtiles'].img, this.dest.x, this.dest.y, this.size.x,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						};
						Powerup.prototype.Update=function(_offset){
							//if(_offset){this.position.x = this.staticPosition.x + _offset; }

							if((this.position.x+this.size.x)-g_Level.viewport.x <= 0 || !this.active){
								this.inView = false; this.collision = false; this.active = false; return false;
							}else
							if(((this.position.x)-g_Level.viewport.x) >= (playWidth) || (this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight)){ this.collision = false; this.inView = false; return false; }

							if(!this.inView)this.inView = true;
							if(!this.collision)this.collision = true;
							
						};
						Powerup.prototype.Trigger=function(obj){
							var self = this;

							if(obj.type==='Player'){
								if(this.type==='BazookaPowerUp'){this.Die(); g_Player.powerUp(Character.POWERUPS[g_Player.type].BAZOOKA); }
								if(this.type==='BoozePowerUp'){this.Die(); g_Player.powerUp(Character.POWERUPS[g_Player.type].BOOZE); }
								if(this.type==='BikePowerUp'){this.Die(); g_Player.powerUp(Character.POWERUPS[g_Player.type].BIKE); }
							}
						};
						Powerup.prototype.Spawn=function(_inc, _offset){
							
							for(var i = 0, len=g_Level.levels[g_Level.currentLevel].collectableSpawnPoints.length; i < len; i++){
								if((g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].x + _offset) - g_Level.viewport.x >= playWidth){
									
									this.collision = true;
									this.inView = true;
									this.active = true;
									i = i + _inc;
									if(i >= g_Level.levels[g_Level.currentLevel].collectableSpawnPoints.length)i=0;
									this.position.x = (g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].x + _offset) - (Math.abs(this.size.x-g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].w));
									this.position.y = g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].y - (Math.abs(this.size.y-g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].h));
									/*this.staticPosition.x = this.position.x;
									this.staticPosition.y = this.position.y;*/

									break;
								};
							};
						};;
								function Collectable(_opts){

							this.position = new Vector( _opts&&_opts.x || 0, _opts&& _opts.y || 0);
							//this.staticPosition = new Vector(this.position.x, this.position.y);

							this.size = new Vector( _opts&&_opts.w || 0,  _opts&&_opts.h || 0);
							this.bbox = new Vector( _opts&&_opts.bx ||  _opts&&_opts.w,  _opts&&_opts.by ||  _opts&&_opts.h);
							this.dest = new Vector( _opts&&_opts.dx || 0,  _opts&&_opts.dy || 0);
							this.inView = false;
							this.collision = _opts&&_opts.collision || false;
							this.type = this.constructor.name;
							this.layer=12;
							this.active = false;

							this.isFg = _opts.isFg;
						};

						Collectable.prototype.Restart=function(){
							this.Die();
						}
						Collectable.prototype.Die=function(){
							this.collision = false;
							this.inView = false;
							this.active = false;
						};
						Collectable.prototype.Render=function(){
							if(!Arena.spriteSheets['goodtiles'] || !Arena.spriteSheets['goodtiles'].img || !Arena.spriteSheets['goodtiles'].spritesLoaded || !this.inView || !this.active )return false;
							ctx.drawImage(Arena.spriteSheets['goodtiles'].img, this.dest.x, this.dest.y, this.size.x,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						};

						Collectable.prototype.Update=function(_offset){
							//if(_offset){this.position.x = this.staticPosition.x + _offset; }

							if((this.position.x+this.size.x)-g_Level.viewport.x <= 0 || !this.active){
								this.inView = false; this.collision = false; this.active = false; return false;
							}else
							if(((this.position.x)-g_Level.viewport.x) >= (playWidth) || (this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight)){ this.collision = false; this.inView = false; return false;}

							if(!this.inView)this.inView = true;
							if(!this.collision)this.collision = true;

						};
						Collectable.prototype.Trigger=function(obj){
							var self = this;

							if(obj.type==='Player'){
								if(this.type==='CoinCollectable'){this.Die(); if(g_Player!==null)g_Player.score++;}
							}
						};
						Collectable.prototype.Spawn=function(_inc, _offset){
							
							for(var i = 0, len=g_Level.levels[g_Level.currentLevel].collectableSpawnPoints.length; i < len; i++){
								if((g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].x + _offset) - g_Level.viewport.x >= playWidth){
									
									this.collision = true;
									this.inView = true;
									this.active = true;
									i = i + _inc;
									if(i >= g_Level.levels[g_Level.currentLevel].collectableSpawnPoints.length)i=0;
									this.position.x = (g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].x + _offset) - (Math.abs(this.size.x-g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].w));
									this.position.y = g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].y - (Math.abs(this.size.y-g_Level.levels[g_Level.currentLevel].collectableSpawnPoints[i].h));
									/*this.staticPosition.x = this.position.x;
									this.staticPosition.y = this.position.y;*/
									break;
								};
							};
						};;
								function BikePowerUp(_opts){
						/*	var randomIndex = Math.round(Math.random() * g_Level.collectableSpawnPoints.length-1);
							var _sp = g_Level.collectableSpawnPoints[randomIndex];
						*/
							Powerup.call(this,{
								x:-1000,
								y:-1000,
								w:54,
								h:23,
								dx:96,
								dy:522,
								isFg:_opts.isFg
							});
						};
						BikePowerUp.prototype = Object.create(Powerup.prototype);
						BikePowerUp.prototype.constructor=BikePowerUp;
						BikePowerUp.prototype.parent = Powerup.prototype;;
								function BoozePowerUp(_opts){
							/*var randomIndex = Math.round(Math.random() * g_Level.collectableSpawnPoints.length-1);
							var _sp = g_Level.collectableSpawnPoints[randomIndex];*/

							Powerup.call(this,{
								x:-1000,
								y:-1000,
								w:Arena.TILESIZE,
								h:Arena.TILESIZE,
								dx:64,
								dy:512,
								isFg:_opts.isFg
							});
						};
						BoozePowerUp.prototype = Object.create(Powerup.prototype);
						BoozePowerUp.prototype.constructor=BoozePowerUp;
						BoozePowerUp.prototype.parent = Powerup.prototype;;
								function BazookaPowerUp(_opts){
						/*	var randomIndex = Math.round(Math.random() * g_Level.collectableSpawnPoints.length-1);
							var _sp = g_Level.collectableSpawnPoints[randomIndex];
						*/
							Powerup.call(this,{
								x:-1000,
								y:-1000,
								w:Arena.TILESIZE,
								h:Arena.TILESIZE,
								dx:320,
								dy:480,
								isFg:_opts.isFg
							});
						};
						BazookaPowerUp.prototype = Object.create(Powerup.prototype);
						BazookaPowerUp.prototype.constructor=BazookaPowerUp;
						BazookaPowerUp.prototype.parent = Powerup.prototype;;
								function CoinCollectable(_opts){
						/*	var randomIndex = Math.round(Math.random() * g_Level.collectableSpawnPoints.length-1);
							var _sp = g_Level.collectableSpawnPoints[randomIndex];*/

							Powerup.call(this,{
								x:-1000,
								y:-1000,
								w:Arena.TILESIZE,
								h:Arena.TILESIZE,
								dx:32,
								dy:512,
								isFg:_opts.isFg
							});
						};
						CoinCollectable.prototype = Object.create(Collectable.prototype);
						CoinCollectable.prototype.constructor=CoinCollectable;
						CoinCollectable.prototype.parent = Collectable.prototype;;
								function Light(_opts){

							this.position = new Vector(_opts&&_opts.x || -1000, _opts&&_opts.y || -1000);
							this.staticPosition = new Vector(_opts&&_opts.x || -1000, _opts&&_opts.y || -1000);
							this.size = new Vector(_opts&&_opts.w || 0, _opts&&_opts.h || 0);
							this.dest = new Vector(_opts&&_opts.dx || 0, _opts&&_opts.dy || 0);
							this.srcsize = new Vector(_opts&&_opts.sw || 0, _opts&&_opts.sh || 0);
							this.offset = new Vector(_opts&&_opts.ox || 0, _opts&&_opts.oy || 0);
							this.inView = false;
							this.type = this.constructor.name;
							this.flicker = _opts&&_opts.flicker || Light.FLICKER.RANDOM;
							this.name = _opts&&_opts.name || 'default';

						};

						Light.FLICKER = {
							RANDOM:{
								Render:function(){
									if(Math.round(Math.random() * (4))===0) ctx.globalAlpha = Math.random() * (1);
								},
								Finish:function(){
									ctx.globalAlpha = 1;
								},
								name:'RANDOM'
							},
							DEFAULT:{
								Render:function(){
									
								},
								Finish:function(){
									
								},
								name:'DEFAULT'
							},
							LINEAR:{
								currentTimer:0,
								isOff:false,
								currentOffset:120,
								Render:function(){
									if(this.isOff){
										ctx.globalAlpha = 0.5;
									}else{
										ctx.globalAlpha = 1;
									}

									if(this.currentTimer++ >= this.currentOffset){
										this.currentTimer = 0;
										this.currentOffset = Math.round(Math.random() * (120-90)+90);
										this.isOff = !this.isOff;
									}
								},
								Finish:function(){
									ctx.globalAlpha = 1;
								},
								name:'LINEAR'
							}
						};

						Light.prototype.Restart=function(){
							this.position.x = this.staticPosition.x;
							this.position.y = this.staticPosition.y;
						};
						Light.prototype.Render=function(_offset){

							if(_offset)this.position.x = this.staticPosition.x + _offset;

							if(!Arena.spriteSheets['lights'] || !Arena.spriteSheets['lights'].img || !Arena.spriteSheets['lights'].spritesLoaded)return false;
							if((this.position.x-g_Level.viewport.x) > playWidth || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)<= 0 || (this.position.y >= playHeight+g_Level.viewport.y)){this.inView=false; return false;}

							this.flicker.Render();

							ctx.drawImage(Arena.spriteSheets['lights'].img, this.dest.x, this.dest.y, this.srcsize.x, this.srcsize.y, (this.position.x-this.offset.x) - g_Level.viewport.x - g_Level.shakeViewport.x, (this.position.y-this.offset.y) - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x, this.size.y);
							
							this.flicker.Finish();
							
						}; ;
								function Mask(_opts){
							this.position = new Vector(_opts&&_opts.x || 0, _opts&&_opts.y || 0);
							this.size = new Vector(_opts&&_opts.w || 196, _opts&&_opts.h || 240);
							this.srcSize = new Vector(_opts&&_opts.sw || this.size.x, _opts&&_opts.sh || this.size.y);
							this.dest = new Vector(_opts&&_opts.dx || 196, _opts&&_opts.dy || 0);

							this.currentFrameX = 0;
							this.maxFrameX = 3;
							this.frameDelay = 0;
							this.frameDelayAmount = 6;
						};

						Mask.prototype.Animate=function(){
							if(this.frameDelay++ > this.frameDelayAmount)
							{
								this.frameDelay = 0;
								this.currentFrameX++;
								if(this.currentFrameX >= this.maxFrameX)
								{	
									this.currentFrameX = 0;
								}
							}
						};

						Mask.prototype.Render=function(){
							if(!Arena.spriteSheets['mesh'] || !Arena.spriteSheets['mesh'].img || !Arena.spriteSheets['mesh'].spritesLoaded) return false;
							this.Animate();
							oCtx.drawImage(Arena.spriteSheets['mesh'].img, (this.srcSize.x)*this.currentFrameX , 0 , this.srcSize.x , this.srcSize.y , this.position.x , this.position.y ,this.size.x, this.size.y);
						};;
								function Arena(_opts){
							var self = this;
							this.viewport = new Vector(_opts.vx || 0, _opts.vy || 0);
							this.shakeViewport = new Vector(0,0);
							this.evilViewport = new Vector(128,0);
							this.type = this.constructor.name;
							
							
							//this.lt = 0;
							//this.targetviewport = new Vector(0,0);


							this.yTimer = 0;
							this.evilTimer = 0;
							this.evilTimerAmount = 30;


							this.levels = {};
							this.previousLevel = null;
							this.currentLevel = 0;
							this.nextLevel = 1;

							/*this.children = [];
							this.collisionChildren = [];
							this.lights = [];*/
							

							/*this.items = {
								bazooka:{},
								coins:{},
								bikes:{},
								booze:{},
								bazookaCount:0,
								coinsCount:0,
								bikesCount:0,
								boozeCount:0,
								randomIndex:0,
								randomChance:0,
								randomChanceMultiplier:0
							};*/


							this.shake = false;
							this.shakeObj={
								radius:30.0,
								randomAngle:Math.round(Math.random()%360),
								offset:( Math.sin(0) * 1 , Math.cos(0) * 1),
								Finish:function(){
									self.shake = false;
									self.shakeObj.radius = 30.0;
									self.shakeViewport.x = 0;
									self.shakeViewport.y = 0;
								},
								Restart:function(){ self.shakeObj.Finish(); }
							};
							

							this.randomEnemyIndex = 0;
							/*this.enemySpawnPoints = [];
							this.collectableSpawnPoints = [];*/


							/*PREVIOUSLEVEL*/
							this.fgBadIndexsPrevious = [];
							this.bgBadIndexsPrevious = [];
							this.fgIndexsPrevious = [];
							this.bgIndexsPrevious = [];


							/*CURRENTLEVEL*/
							this.fgBadIndexs = [];
							this.bgBadIndexs = [];
							this.fgIndexs = [];
							this.bgIndexs = [];

							/*NEXTLEVEL*/
							this.fgBadIndexsNext = [];
							this.bgBadIndexsNext = [];
							this.fgIndexsNext = [];
							this.bgIndexsNext = [];


							this.levels = [
								"game/assets/tiled/level1.json",
								"game/assets/tiled/level2.json",
								"game/assets/tiled/level3.json"
							];
							
							this.currentLoadLevel = 0;
							this.maxLoadLevel = this.levels.length;

							this.loadLevels();

							this.minAlpha = 0.1;
							this.maxAlpha = 0.4;
							this.isMaxAlpha = false;
							this.isMinAlpha = true;
							this.currentAlpha = this.minAlpha;

							this.evilStrength = 1;
						};

						/*
						==========
						STATIC
						==========
						*/
						Arena.TILESIZE = 32;
						Arena.spriteSheets = {}; //dynamically filled.
						Arena.MAXASSETS = 23;
						Arena.CURRENTASSETS = 0;
						/*
						==========
						FUNCS
						==========
						*/
						Arena.prototype.loadLevels=function(){
							var self = this;
							$.ajax(self.levels[this.currentLoadLevel], {
						    dataType:"json", 
						    success: function(data) { 
						    	window.e=data; 
						        self.produceLevel(data,self.currentLoadLevel);
						        self.currentLoadLevel++;
						        if(self.currentLoadLevel >= self.maxLoadLevel){
						        	//do something -- load images etc...
						        	self.loadBitmaps();
						        	return;
						        };

						        self.loadLevels();

						    }});
						};

						Arena.prototype.produceLevel=function(data, id){
							var self = this;

							this.levels[id] = {}; //create a new object for the level data.

							this.levels[id].id = id;
							this.levels[id].scrollWidth = data.width*Arena.TILESIZE;
							this.levels[id].scrollHeight = data.height*Arena.TILESIZE;
							this.levels[id].staticScrollWidth = data.width*Arena.TILESIZE;
							this.levels[id].staticScrollHeight = data.height*Arena.TILESIZE;
							this.levels[id].children = [];
							this.levels[id].enemySpawnPoints = [];
							this.levels[id].lights = [];
							this.levels[id].collectableSpawnPoints = [];
							this.levels[id].collisionChildren = [];
							this.levels[id].items = {
								bazooka:{},
								coins:{},
								bikes:{},
								booze:{},
								bazookaCount:0,
								coinsCount:0,
								bikesCount:0,
								boozeCount:0,
								randomIndex:0,
								randomChance:0,
								randomChanceMultiplier:0
							};
							self.levels[id].linkTileToExplosion = {
								1:[], //TRUCK
								2:[] // SUV
							};
							
							this.viewport.y = this.levels[id].scrollHeight-this.levels[id].playHeight; //fix untill we can center viewport correctly.

							for(var l = 0, len = data.layers.length; l < len; l++){

								data.layers[l].data.forEach(function(tile_idx, i) {
									if (!tile_idx) { return; }

									var img_x, img_y, s_x, s_y;

									var j = 0;
									for (j = data.tilesets.length-1; j >= 0; j--) {
										if (data.tilesets[j].firstgid <= tile_idx) break;
									}
									var tile = data.tilesets[j];

									tile_idx -= tile.firstgid;
									img_x = (tile_idx % (tile.imagewidth / Arena.TILESIZE)) * Arena.TILESIZE;
									img_y = ~~(tile_idx / (tile.imagewidth / Arena.TILESIZE)) * Arena.TILESIZE;


									s_x = (i % data.layers[l].width) * Arena.TILESIZE;
									s_y = ~~(i / data.layers[l].width) * Arena.TILESIZE;


									var _collision = data.layers[l].properties&&data.layers[l].properties.collision==='true' ? true : false;
									var _platform = data.layers[l].properties&&data.layers[l].properties.platform==='true' ? true : false;
									//5 ignore bullet -- 3 normal
									var _layer = data.layers[l].properties&&data.layers[l].properties.ignore==='true' ? 5 : 3;
									//Tile.TYPE.bazooka Tile.TYPE.bike
									var _enemy_layer = data.layers[l].properties&&data.layers[l].properties.layer ? parseInt(data.layers[l].properties.layer) : 3;

									//var _type = data.layers[l].properties&&data.layers[l].properties.powerup&&data.layers[l].properties.poweruptype ? Tile.TYPE[data.layers[l].properties.poweruptype] : Tile.TYPE.tile;
									var _collectable_point = data.layers[l].properties&&data.layers[l].properties.collectableSpawnPoint ? true : false; 

									var _halfsize = data.layers[l].properties&&data.layers[l].properties.halfsize ? Arena.TILESIZE/2 : Arena.TILESIZE;

									var _spawn_point = data.layers[l].properties&&data.layers[l].properties.spawnpoint ? true : false;
									var _light_spawn_point = data.layers[l].properties&&data.layers[l].properties.lightspawn ? true : false;

									var _foreground = data.layers[l].properties&&data.layers[l].properties.foreground ? true : false;

									var _truckexplosion = data.layers[l].properties&&data.layers[l].properties.truckexplosion ? true : false;
									var _suvexplosion = data.layers[l].properties&&data.layers[l].properties.suvexplosion ? true : false;



									if(_spawn_point){
										self.levels[id].enemySpawnPoints.push({x:s_x,y:s_y,w:Arena.TILESIZE, h:Arena.TILESIZE});
									}else
									if(_light_spawn_point){
										var _light_type = data.layers[l].properties&&data.layers[l].properties.lighttype;
										switch(_light_type){
											case 'tree':
												self.levels[id].lights.push(new Light({flicker:Light.FLICKER.LINEAR, x:s_x, y:s_y, w:32, h:64, dx:64, dy:0, ox:0,oy:0, sw:32,sh:64,name:'Tree'}));
											break;

											case 'lamp':
												var _flicker = Math.round(Math.random() * (3));
												if(_flicker===0){self.levels[id].children.push(new LadyOfTheNight({x:s_x, y:(s_y + (Arena.TILESIZE*1.5)), isFg:true})); /*self.foregroundChildren.push(self.children[self.children.length-1]);*/}
												self.levels[id].lights.push(new Light({flicker:_flicker===0 ? Light.FLICKER.RANDOM : Light.FLICKER.DEFAULT, x:s_x, y:s_y, w:48, h:128, dx:0, dy:0, ox:12,oy:-3, sw:48,sh:128,name:'Lamp'}));
											break;

											case 'window':
												self.levels[id].lights.push(new Light({flicker:Math.round(Math.random() * (1))=== 0 ? Light.FLICKER.RANDOM : Light.FLICKER.DEFAULT, x:s_x, y:s_y, w:54, h:27, dx:96, dy:0, ox:-6,oy:-16, sw:54,sh:27,name:'Window'}));
											break;

											case 'smallwindow':
												self.levels[id].lights.push(new Light({flicker:Math.round(Math.random() * (1))=== 0 ? Light.FLICKER.RANDOM : Light.FLICKER.DEFAULT, x:s_x, y:s_y, w:54, h:27, dx:160, dy:0, ox:-22,oy:-14, sw:54,sh:27,name:'SmallWindow'}));
											break;
										}
									}else
									if(_collectable_point){
										self.levels[id].collectableSpawnPoints.push({x:s_x,y:s_y,w:Arena.TILESIZE, h:Arena.TILESIZE});
									}else
									{
										self.levels[id].children.push( new Tile({isFg:_foreground, enemylayer:_enemy_layer, type:Tile.TYPE.tile, by:_halfsize,  x:s_x, y:s_y, w:Arena.TILESIZE, h:Arena.TILESIZE, dx:img_x, dy:img_y, collision:_collision, platform:_platform, layer:_layer }));
										if(_collision){
											self.levels[id].collisionChildren.push(self.levels[id].children[self.levels[id].children.length-1]);
											if(_layer===3){
												self.levels[id].children[self.levels[id].children.length-1].children.push( new Explosion() );
												self.levels[id].children[self.levels[id].children.length-1].createParticle();

												if(_truckexplosion){
													self.levels[id].children[self.levels[id].children.length-1].tileType = Tile.TYPE.truck;
													self.levels[id].linkTileToExplosion[Tile.TYPE.truck].push( self.levels[id].children.length-1 );
												}else
												if(_suvexplosion){
													self.levels[id].children[self.levels[id].children.length-1].tileType = Tile.TYPE.suv;
													self.levels[id].linkTileToExplosion[Tile.TYPE.suv].push( self.levels[id].children.length-1 );
												};
											}
										};
										/*if(_foreground){
											self.foregroundChildren.push(self.children[self.children.length-1]);
										}else{
											self.backgroundChildren.push(self.children[self.children.length-1]);
										}*/
									}
							    });
							};

							self.levels[id].enemySpawnPoints.sort(compare);
							self.levels[id].collectableSpawnPoints.sort(compare);
							self.createPowerUps(id);
							self.createCollectables(id);

							
						};

						Arena.prototype.changeLevel=function(){
							for(var i=0,len=this.levels[this.nextLevel].collisionChildren.length; i < len; i++){
								this.levels[this.nextLevel].collisionChildren[i].Restart();
							};
							
							var cl = this.levels[this.currentLevel].id;//this.currentLevel.id;
							var nl = this.levels[this.nextLevel].id;

							this.previousLevel = cl;
							this.currentLevel = nl;//Math.round(Math.random() * (this.maxLoadLevel-1));
							this.nextLevel = Math.round(Math.random() * (this.maxLoadLevel-1));

							if(this.nextLevel === this.currentLevel){
								console.log('BEFORE' + this.nextLevel);
								if(this.nextLevel >= this.maxLoadLevel-1){this.nextLevel--;}else
								if(this.nextLevel <= 0){this.nextLevel++;}else{
									this.nextLevel = Math.round(Math.random * (1))===0 ? this.nextLevel-1 : this.nextLevel+1;
								};
								console.log('UPDAED: ' + this.nextLevel);
							};


							this.levels[this.currentLevel].scrollWidth = this.levels[nl].staticScrollWidth + ((this.viewport.x) + (playWidth/2));

							
						};

						Arena.prototype.loadBitmaps=function(){
							/*
							MENUS
							*/
							Arena.spriteSheets['menu'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/menu/menubg.png',function(sprite){
								Arena.spriteSheets['menu'].img=sprite;
								Arena.spriteSheets['menu'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['menuassets'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/menu/menuassets.png',function(sprite){
								Arena.spriteSheets['menuassets'].img=sprite;
								Arena.spriteSheets['menuassets'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['mobileoverlayassets'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/menu/mobileoverlayassets.png',function(sprite){
								Arena.spriteSheets['mobileoverlayassets'].img=sprite;
								Arena.spriteSheets['mobileoverlayassets'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});


							/*BG*/
							Arena.spriteSheets['goodbackground'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/goodsky.png',function(sprite){
								Arena.spriteSheets['goodbackground'].img=sprite;
								Arena.spriteSheets['goodbackground'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['badbackground'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/badsky.png',function(sprite){
								Arena.spriteSheets['badbackground'].img=sprite;
								Arena.spriteSheets['badbackground'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});


							/*TILES*/
							Arena.spriteSheets['goodtiles'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/tiled/testsprite.png',function(sprite){
								Arena.spriteSheets['goodtiles'].img=sprite;
								Arena.spriteSheets['goodtiles'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['eviltiles'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/tiled/testspriteevil.png',function(sprite){
								Arena.spriteSheets['eviltiles'].img=sprite;
								Arena.spriteSheets['eviltiles'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['bullets'] = { 
								BazookaBullet:{
									img:null,
									spritesLoaded:false
								},
								GunBullet:{
									img:null, 
									spritesLoaded:false 
								}
							};

							loadSprites('game/assets/bullet.png',function(sprite){
								Arena.spriteSheets['bullets']['GunBullet'].img=sprite;
								Arena.spriteSheets['bullets']['GunBullet'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							loadSprites('game/assets/bulletbazooka.png',function(sprite){
								Arena.spriteSheets['bullets']['BazookaBullet'].img=sprite;
								Arena.spriteSheets['bullets']['BazookaBullet'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['particles'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/particles.png',function(sprite){
								Arena.spriteSheets['particles'].img=sprite;
								Arena.spriteSheets['particles'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['guns'] = { 
								machinegun:{img:null, spritesLoaded:false },
								bazooka:{img:null, spritesLoaded:false }
							};
							loadSprites('game/assets/machinegun.png',function(sprite){
								Arena.spriteSheets['guns'].machinegun.img=sprite;
								Arena.spriteSheets['guns'].machinegun.spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});
							loadSprites('game/assets/bazooka.png',function(sprite){
								Arena.spriteSheets['guns'].bazooka.img=sprite;
								Arena.spriteSheets['guns'].bazooka.spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['muzzles'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/muzzle.png',function(sprite){
								Arena.spriteSheets['muzzles'].img=sprite;
								Arena.spriteSheets['muzzles'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['snow'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/snow.png',function(sprite){
								Arena.spriteSheets['snow'].img=sprite;
								Arena.spriteSheets['snow'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['topfade'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/topfade.png',function(sprite){
								Arena.spriteSheets['topfade'].img=sprite;
								Arena.spriteSheets['topfade'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['badfilter'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/badfilter.png',function(sprite){
								Arena.spriteSheets['badfilter'].img=sprite;
								Arena.spriteSheets['badfilter'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['badfilteroverlay'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/badfilteroverlay.png',function(sprite){
								Arena.spriteSheets['badfilteroverlay'].img=sprite;
								Arena.spriteSheets['badfilteroverlay'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							/*ENEMIES + PLAYER*/
							Arena.spriteSheets['charactergood'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/charactergood.png',function(sprite){
								Arena.spriteSheets['charactergood'].img=sprite;
								Arena.spriteSheets['charactergood'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['characterbad'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/characterbad.png',function(sprite){
								Arena.spriteSheets['characterbad'].img=sprite;
								Arena.spriteSheets['characterbad'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});


							Arena.spriteSheets['lightingbackground'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/lighting/backgrounddark.png',function(sprite){
								Arena.spriteSheets['lightingbackground'].img=sprite;
								Arena.spriteSheets['lightingbackground'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['lights'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/lighting/lights.png',function(sprite){
								Arena.spriteSheets['lights'].img=sprite;
								Arena.spriteSheets['lights'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['mesh'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/maskSheet.png',function(sprite){
								Arena.spriteSheets['mesh'].img=sprite;
								Arena.spriteSheets['mesh'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});

							Arena.spriteSheets['explosion'] = { img:null, spritesLoaded:false };
							loadSprites('game/assets/explosions.png',function(sprite){
								Arena.spriteSheets['explosion'].img=sprite;
								Arena.spriteSheets['explosion'].spritesLoaded = true;
								Arena.CURRENTASSETS ++;
							});


							game.startElements();
						};

						Arena.prototype.setRandomLevels=function(){

							this.currentLevel = Math.round(Math.random() * (this.maxLoadLevel-1)); //perhaps randomizing this, for a new level on each restart.
							this.nextLevel = Math.round(Math.random() * (this.maxLoadLevel-1));

							if(this.nextLevel === this.currentLevel){
								console.log('BEFORE RESTART' + this.nextLevel);
								if(this.nextLevel >= this.maxLoadLevel-1){console.log('for1!'); this.nextLevel--;}else
								if(this.nextLevel <= 0){console.log('for 2'); this.nextLevel++;}else{
									console.log('for3');
									this.nextLevel = Math.round(Math.random * (1))===0 ? this.nextLevel-1 : this.nextLevel+1;
								};
								console.log('UPDAED RESTART: ' + this.nextLevel);
							};

						};

						Arena.prototype.Restart=function(){
							
							/*this.fgBadIndexsPrevious.length = 0;
							this.bgBadIndexsPrevious.length = 0;
							this.fgIndexsPrevious.length = 0;
							this.bgIndexsPrevious.length = 0;

							this.fgBadIndexs.length = 0;
							this.bgBadIndexs.length = 0;
							this.fgIndexs.length = 0;
							this.bgIndexs.length = 0;

							
							this.fgBadIndexsNext.length = 0;
							this.bgBadIndexsNext.length = 0;
							this.fgIndexsNext.length = 0;
							this.bgIndexsNext.length = 0;*/


							//reset the current level.
							this.setRandomLevels();
							this.previousLevel = null;

							this.viewport.x = 0;
							this.viewport.y = this.levels[this.currentLevel].scrollHeight-playHeight; // fix untill center viewport is done.
							this.evilViewport.x = 128;
							this.shakeObj.Restart();
							this.shake = false;
							/*for(var i = 0, len = this.children.length; i < len; i++){
								this.children[i].Restart();
							}*/
							for(var i = 0, len = Object.keys(this.levels).length; i < len; i++){

								this.levels[i].scrollWidth = this.levels[i].staticScrollWidth;

								for(var j=0,len2=this.levels[i].children.length; j < len2; j++){
									this.levels[i].children[j].Restart(true);
								};
								for(var j=0,len2=this.levels[i].lights.length; j < len2; j++){
									this.levels[i].lights[j].Restart();
								};
							};

							this.evilTimer = 0;

							this.Update();
						}

						Arena.prototype.Update=function(){
							
							if(this.shake){this.doShake();}

							if(this.previousLevel !== null&&this.viewport.x<=this.levels[this.previousLevel].scrollWidth){
								this.bgBadIndexsPrevious.length = 0;
								this.fgBadIndexsPrevious.length = 0;
								this.bgIndexsPrevious.length = 0;
								this.fgIndexsPrevious.length = 0;

								for(var i = 0, len = this.levels[this.previousLevel].children.length; i < len; i++){
									this.levels[this.previousLevel].children[i].Update();
									if(this.levels[this.previousLevel].children[i].inView){
										if(this.levels[this.previousLevel].children[i].isFg){
											this.fgIndexsPrevious.push(i); 
											if(this.levels[this.previousLevel].children[i].isEvil)this.fgBadIndexsPrevious.push(i);
											continue;
										} 
										if(this.levels[this.previousLevel].children[i].isEvil)this.bgBadIndexsPrevious.push(i);
										this.bgIndexsPrevious.push(i); 
										continue; 
									}
								};
							};

							this.bgBadIndexs.length = 0;
							this.fgBadIndexs.length = 0;
							this.bgIndexs.length = 0;
							this.fgIndexs.length = 0;


							for(var i = 0, len = this.levels[this.currentLevel].children.length; i < len; i++){
								this.levels[this.currentLevel].children[i].Update();
								if(this.levels[this.currentLevel].children[i].inView){
									if(this.levels[this.currentLevel].children[i].isFg){
										this.fgIndexs.push(i); 
										if(this.levels[this.currentLevel].children[i].isEvil)this.fgBadIndexs.push(i);
										continue;
									} 
									if(this.levels[this.currentLevel].children[i].isEvil)this.bgBadIndexs.push(i);
									this.bgIndexs.push(i); 
									continue; 
								}
							};

							//console.log('VIEWPORTX: ' + ((this.viewport.x)+(playWidth)) + ', CL SCROLLWIDTH: ' + this.levels[this.currentLevel].scrollWidth);

							if(((this.viewport.x)+(playWidth)) < this.levels[this.currentLevel].scrollWidth)return; //add a check to change currentLevel to the *next* level and add the new next level.
							this.bgBadIndexsNext.length = 0;
							this.fgBadIndexsNext.length = 0;
							this.bgIndexsNext.length = 0;
							this.fgIndexsNext.length = 0;

							for(var i = 0, len = this.levels[this.nextLevel].children.length; i < len; i++){
								this.levels[this.nextLevel].children[i].Update(this.levels[this.currentLevel].scrollWidth); // add in the offset so it renders in the correct place!
								if(this.levels[this.nextLevel].children[i].inView){
									if(this.levels[this.nextLevel].children[i].isFg){
										this.fgIndexsNext.push(i); 
										if(this.levels[this.nextLevel].children[i].isEvil)this.fgBadIndexsNext.push(i);
										continue;
									} 
									if(this.levels[this.nextLevel].children[i].isEvil)this.bgBadIndexsNext.push(i);
									this.bgIndexsNext.push(i); 
									continue; 
								}
							};
						};



						Arena.prototype.evilWorld=function(){
							if(!g_Player.isEvil)return false;
							g_Player.Trigger(this);
							
						};
						Arena.prototype.catchPlayer=function(){
							if(this.evilViewport.x+1 >= playWidth){this.evilViewport.x = playWidth; return false;}
							this.evilViewport.x += 1;
						};

						Arena.prototype.releaseTheHounds=function(){

							//set a timer, and spawn an enemy, make them the players position.y and edge of canvas!
							if(g_Enemies.length <= 0)return false;
							
							this.randomEnemyIndex = Math.round(Math.random() * (g_Enemies.length-1));
							if(g_Enemies[this.randomEnemyIndex].inView&&!g_Enemies[this.randomEnemyIndex].dead){return false;}
							g_Enemies[this.randomEnemyIndex].Spawn(this.levels[this.currentLevel].scrollWidth - this.levels[this.currentLevel].staticScrollWidth);
						};

						Arena.prototype.Render=function(){

							if(Arena.spriteSheets['goodbackground']&&Arena.spriteSheets['goodbackground'].img&&Arena.spriteSheets['goodbackground'].spritesLoaded){
								var pX = (this.viewport.x % (playWidth / 0.25)) * 0.25; 
								for(var x = 0; x < (playWidth/playWidth) + 1; x++){
									ctx.drawImage(Arena.spriteSheets['goodbackground'].img,0,0,playWidth,playHeight,(x*playWidth) - pX,0,playWidth,playHeight);
								}
							}
							
							/*if(Arena.spriteSheets['badbackground']&&Arena.spriteSheets['badbackground'].img&&Arena.spriteSheets['badbackground'].spritesLoaded){
								ctx.drawImage(Arena.spriteSheets['badbackground'].img, 0 , 0 , this.evilViewport.x ,playHeight, 0,0 , this.evilViewport.x,playHeight);
							}
							*/

							for(var i = 0, len = g_Snow.length; i < len; i++){g_Snow[i].Render();}


							/*TEST PREVIOUS*/
							if(this.previousLevel !== null&&this.viewport.x<=this.levels[this.previousLevel].scrollWidth)
								for(var i = 0, len = this.bgIndexsPrevious.length; i < len; i++){ this.levels[this.previousLevel].children[this.bgIndexsPrevious[i]].Render();}


							for(var i = 0, len = this.bgIndexs.length; i < len; i++){ this.levels[this.currentLevel].children[this.bgIndexs[i]].Render();}
							
							/*TEST*/
							if(((this.viewport.x)+(playWidth)) >= this.levels[this.currentLevel].scrollWidth)
								for(var i = 0, len = this.bgIndexsNext.length; i < len; i++){ this.levels[this.nextLevel].children[this.bgIndexsNext[i]].Render();}


							if(Arena.spriteSheets['lightingbackground']&&Arena.spriteSheets['lightingbackground'].img&&Arena.spriteSheets['lightingbackground'].spritesLoaded){
								ctx.drawImage(Arena.spriteSheets['lightingbackground'].img, 0 , 0 , playWidth ,playHeight, 0,0 , playWidth,playHeight);
							}


							/*TEST PREVIOUS*/
							if(this.previousLevel !== null&&this.viewport.x<=this.levels[this.previousLevel].scrollWidth)
								for(var i = 0, len = this.fgIndexsPrevious.length; i < len; i++){ this.levels[this.previousLevel].children[this.fgIndexsPrevious[i]].Render();}
							

							for(var i = 0, len = this.fgIndexs.length; i < len; i++){ this.levels[this.currentLevel].children[this.fgIndexs[i]].Render();}
							

							/*TEST*/
							if(((this.viewport.x)+(playWidth)) >= this.levels[this.currentLevel].scrollWidth)
								for(var i = 0, len = this.fgIndexsNext.length; i < len; i++){this.levels[this.nextLevel].children[this.fgIndexsNext[i]].Render();}



							/*MASK*/
							oCtx.clearRect(0,0,playWidth,playHeight);

							oCtx.globalCompositeOperation = 'source-over';
							

							/*TEST PREVIOUS*/
							if(this.previousLevel !== null&&this.viewport.x<=this.levels[this.previousLevel].scrollWidth)
								for(var i = 0, len = this.bgBadIndexsPrevious.length; i < len; i++){ if(this.levels[this.previousLevel].children[this.bgBadIndexsPrevious[i]].RenderEvil)this.levels[this.previousLevel].children[this.bgBadIndexsPrevious[i]].RenderEvil(); }


							for(var i = 0, len = this.bgBadIndexs.length; i < len; i++){ if(this.levels[this.currentLevel].children[this.bgBadIndexs[i]].RenderEvil)this.levels[this.currentLevel].children[this.bgBadIndexs[i]].RenderEvil(); }
							
							/*TEST*/
							if(((this.viewport.x)+(playWidth)) >= this.levels[this.currentLevel].scrollWidth)
								for(var i = 0, len = this.bgBadIndexsNext.length; i < len; i++){ if(this.levels[this.nextLevel].children[this.bgBadIndexsNext[i]].RenderEvil)this.levels[this.nextLevel].children[this.bgBadIndexsNext[i]].RenderEvil(); }



							if(Arena.spriteSheets['lightingbackground']&&Arena.spriteSheets['lightingbackground'].img&&Arena.spriteSheets['lightingbackground'].spritesLoaded){
								oCtx.drawImage(Arena.spriteSheets['lightingbackground'].img, 0 , 0 , playWidth ,playHeight, 0,0 , playWidth,playHeight);
							}


							/*TEST PREVIOUS*/
							if(this.previousLevel !== null&&this.viewport.x<=this.levels[this.previousLevel].scrollWidth)
								for(var i = 0, len = this.fgBadIndexsPrevious.length; i < len; i++){  if(this.levels[this.previousLevel].children[this.fgBadIndexsPrevious[i]].RenderEvil)this.levels[this.previousLevel].children[this.fgBadIndexsPrevious[i]].RenderEvil();}


							for(var i = 0, len = this.fgBadIndexs.length; i < len; i++){  if(this.levels[this.currentLevel].children[this.fgBadIndexs[i]].RenderEvil)this.levels[this.currentLevel].children[this.fgBadIndexs[i]].RenderEvil();}
							
							/*TEST*/
							if(((this.viewport.x)+(playWidth)) >= this.levels[this.currentLevel].scrollWidth)
								for(var i = 0, len = this.fgBadIndexsNext.length; i < len; i++){  if(this.levels[this.nextLevel].children[this.fgBadIndexsNext[i]].RenderEvil)this.levels[this.nextLevel].children[this.fgBadIndexsNext[i]].RenderEvil();}


							oCtx.globalCompositeOperation = 'destination-in';

							g_LevelMask.Render(); /*RENDER THE EVIL MASK*/
							
							if(this.evilViewport.x)ctx.drawImage(oCanvas,0,0,this.evilViewport.x,playHeight, 0, 0, this.evilViewport.x, playHeight);

							/*ENDOFMASK*/


							/*Lights*/
							ctx.globalCompositeOperation = "overlay";
							for(var i = 0, len = this.levels[this.currentLevel].lights.length; i < len; i++){
								this.levels[this.currentLevel].lights[i].Render();
							};

							/*TEST*/
							if((this.viewport.x+playWidth) >= this.levels[this.currentLevel].scrollWidth)
								for(var i = 0, len = this.levels[this.nextLevel].lights.length; i < len; i++){
								this.levels[this.nextLevel].lights[i].Render(this.levels[this.currentLevel].scrollWidth);
							};

							ctx.globalCompositeOperation = "source-over";


							for(var i = 0, len = g_Enemies.length; i < len; i++)g_Enemies[i].Render();
							
							g_Player.Render();
							

							/*RED FLASH*/
							if(g_Player.health <= (g_Player.maxhealth*0.25)){
								ctx.globalCompositeOperation = "overlay";
									if(this.isMaxAlpha){
										this.currentAlpha -= 0.01;
									}else{
										this.currentAlpha += 0.01;
									}

									if(this.currentAlpha >= this.maxAlpha){this.isMaxAlpha = true; this.isMinAlpha = false;}
									if(this.currentAlpha <= this.minAlpha){this.isMinAlpha = true; this.isMaxAlpha = false;}

									ctx.fillStyle = "rgba(255, 0, 0, " +  this.currentAlpha + ")";
									ctx.fillRect(0, 0, playWidth,playHeight);
								ctx.globalCompositeOperation = "source-over";
							}
							this.renderUI();

						};
						Arena.prototype.renderUI=function(){


							/*if(Arena.spriteSheets['badfilter']&&Arena.spriteSheets['badfilter'].img&&Arena.spriteSheets['badfilter'].spritesLoaded){
								var pY = (this.yTimer % (Arena.spriteSheets['badfilter'].img.height / 0.25)) * 0.25;
								for(var y = 0; y < (playHeight/playHeight) + 1; y++){
									ctx.drawImage(Arena.spriteSheets['badfilter'].img,0,0,Arena.spriteSheets['badfilter'].img.width,Arena.spriteSheets['badfilter'].img.height,0,((-y)*Arena.spriteSheets['badfilter'].img.height) + pY,Arena.spriteSheets['badfilter'].img.width,Arena.spriteSheets['badfilter'].img.height);
								}
							}*/

							if(Arena.spriteSheets['badfilteroverlay']&&Arena.spriteSheets['badfilteroverlay'].img&&Arena.spriteSheets['badfilteroverlay'].spritesLoaded){
								ctx.drawImage(Arena.spriteSheets['badfilteroverlay'].img,0,0,Arena.spriteSheets['badfilteroverlay'].img.width,Arena.spriteSheets['badfilteroverlay'].img.height);
							}

							if(Arena.spriteSheets['topfade']&&Arena.spriteSheets['topfade'].img&&Arena.spriteSheets['topfade'].spritesLoaded){
								ctx.drawImage(Arena.spriteSheets['topfade'].img,0,0,Arena.spriteSheets['topfade'].img.width,Arena.spriteSheets['topfade'].img.height);
							}

						};


						Arena.prototype.incX=function(){
							if(this.viewport.x+playWidth > (this.levels[this.currentLevel].scrollWidth))return false;
							this.viewport.x ++;
						};
						Arena.prototype.incY=function(){
							if(this.viewport.y+playHeight > (this.levels[this.currentLevel].scrollHeight))return false;
							this.viewport.y ++;
						};
						Arena.prototype.decX=function(){
							if(this.viewport.x <= 0)return false;
							this.viewport.x --;
						};
						Arena.prototype.decY=function(){
							if(this.viewport.y <= 0)return false;
							this.viewport.y --;	
						};
						Arena.prototype.incAX=function(_val){
							this.viewport.x += _val;
						};
						Arena.prototype.incAY=function(_val){
							this.viewport.y += _val;
						};
						Arena.prototype.adjX=function(_val){
							this.viewport.x = _val;
						};
						Arena.prototype.adjY=function(_val){
							this.viewport.y = _val;
						};

						Arena.prototype.UpdateViewport=function(){
							this.viewport.x = g_Player.position.x - (playWidth/2) | 0;
							this.viewport.y = g_Player.position.y - (playHeight/2) | 0;

							//if(this.viewport.x+playWidth >= (this.levels[this.currentLevel].scrollWidth)){ this.viewport.x = (this.levels[this.currentLevel].scrollWidth-playWidth);  }
							if(this.viewport.x <= 0) { this.viewport.x = 0; }
							if(this.viewport.y+playHeight >= (this.levels[this.currentLevel].scrollHeight)){ this.viewport.y = (this.levels[this.currentLevel].scrollHeight-playHeight); }
							if(this.viewport.y <= 0) { this.viewport.y = 0; }
						};

						Arena.prototype.decreaseEvilViewport=function(){
							if(this.evilViewport.x-2 <= 128){this.evilViewport.x = 128; return;}
							this.evilViewport.x -= 2;
						};


						Arena.prototype.doShake=function(){
							
							this.shakeObj.radius *=0.9; //diminish radius each frame
						    this.shakeObj.randomAngle += (150 + Math.round(Math.random()%60)); //pick new angle 
						    this.shakeObj.offset = {x:( Math.sin(this.shakeObj.randomAngle) * this.shakeObj.radius), y:(Math.cos(this.shakeObj.randomAngle) * this.shakeObj.radius)}; //create offset 2d vector
						   	
						   	this.shakeViewport.x = this.shakeObj.offset.x;
						   	this.shakeViewport.y = this.shakeObj.offset.y;

						   	if(this.shakeObj.radius <= 1)this.shakeObj.Finish();
						};

						Arena.prototype.centerView=function(x,y){
							this.viewport.x = x - (playWidth / 2); 
							this.viewport.y = y - (playHeight / 2);
							
							if(this.viewport.x < 0) 
							{
								this.viewport.x = 0; 
							}
							if(this.viewport.x > this.levels[this.currentLevel].scrollWidth - 1)
							{
								this.viewport.x = this.levels[this.currentLevel].scrollWidth - 1; 
							}
							if(this.viewport.y < 0) 
							{
								this.viewport.y = 0; 
							}
							if(this.viewport.y > (this.levels[this.currentLevel].scrollHeight-(playWidth/2)) - 1) 
							{
								this.viewport.y = (this.levels[this.currentLevel].scrollHeight-(playWidth/2)) - 1; 
							}
						};
						Arena.prototype.isXCenter=function(x){
							return Math.abs((x == this.viewport.x +  (playWidth / 2))) || Math.abs(x == this.viewport.x - (playWidth / 2)) ? true : false; 
						};
						Arena.prototype.isYCenter=function(y){
							return (y == this.viewport.y +  (playHeight / 2) || y == this.viewport.y - (playHeight / 2)) ? true : false;
						};

						Arena.prototype.createPowerUps=function(id){

							for(var i = 0, len = 10; i < len; i++){
								this.levels[id].collisionChildren.push(new BazookaPowerUp({isFg:true}));
								this.levels[id].children.push(this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1]);
								//this.foregroundChildren.push(this.collisionChildren[this.collisionChildren.length-1]);
								this.levels[id].items.bazooka[i] = this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1];
								this.levels[id].items.bazookaCount++;


								this.levels[id].collisionChildren.push(new BoozePowerUp({isFg:true}));
								this.levels[id].children.push(this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1]);
								//this.foregroundChildren.push(this.collisionChildren[this.collisionChildren.length-1]);
								this.levels[id].items.booze[i] = this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1];
								this.levels[id].items.boozeCount++;

								if(i > 0)continue;

								this.levels[id].collisionChildren.push( new BikePowerUp({isFg:true}));
								this.levels[id].children.push(this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1]);
								//this.foregroundChildren.push(this.collisionChildren[this.collisionChildren.length-1]);
								this.levels[id].items.bikes[i] = this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1];
								this.levels[id].items.bikesCount++;

							};

						};
						Arena.prototype.createCollectables=function(id){
							for(var i = 0, len = 10; i < len; i++){
								this.levels[id].collisionChildren.push( new CoinCollectable({isFg:true}));
								this.levels[id].children.push(this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1]);
								//this.foregroundChildren.push(this.collisionChildren[this.collisionChildren.length-1]);
								this.levels[id].items.coins[i] = this.levels[id].collisionChildren[this.levels[id].collisionChildren.length-1];
								this.levels[id].items.coinsCount++;
							};
						};

						Arena.prototype.generateItems=function(){
							/*COINS*/

							if(this.levels[this.currentLevel].items.coinsCount > 0){
								this.levels[this.currentLevel].items.randomIndex = Math.round(Math.random() * (this.levels[this.currentLevel].items.coinsCount-1));
								if(!this.levels[this.currentLevel].items.coins[this.levels[this.currentLevel].items.randomIndex].inView&&!this.levels[this.currentLevel].items.coins[this.levels[this.currentLevel].items.randomIndex].active){
									this.levels[this.currentLevel].items.coins[this.levels[this.currentLevel].items.randomIndex].Spawn(0,this.levels[this.currentLevel].scrollWidth - this.levels[this.currentLevel].staticScrollWidth);
								};
							};

							/*BOOZE*/
							if(this.levels[this.currentLevel].items.boozeCount > 0){
								this.levels[this.currentLevel].items.randomChanceMultiplier = g_Player.health <= 25 ? 3 : g_Player.health <= 50 ? 6 : 10;
								this.levels[this.currentLevel].items.randomChance = Math.round( Math.random() * (this.levels[this.currentLevel].items.randomChanceMultiplier));
								if(this.levels[this.currentLevel].items.randomChance === 0){
									this.levels[this.currentLevel].items.randomIndex = Math.round(Math.random() * (this.levels[this.currentLevel].items.boozeCount-1));
									if(!this.levels[this.currentLevel].items.booze[this.levels[this.currentLevel].items.randomIndex].inView&&!this.levels[this.currentLevel].items.booze[this.levels[this.currentLevel].items.randomIndex].active){
										this.levels[this.currentLevel].items.booze[this.levels[this.currentLevel].items.randomIndex].Spawn(1,this.levels[this.currentLevel].scrollWidth - this.levels[this.currentLevel].staticScrollWidth);
									};
								};
							};

							/*BAZOOKA*/
							if(this.levels[this.currentLevel].items.bazookaCount > 0&&!g_Player.hasBazooka){
								this.levels[this.currentLevel].items.randomChance = Math.round( Math.random() * (10));
								if(this.levels[this.currentLevel].items.randomChance === 0){
									this.levels[this.currentLevel].items.randomIndex = Math.round(Math.random() * (this.levels[this.currentLevel].items.bazookaCount-1));
									if(!this.levels[this.currentLevel].items.bazooka[this.levels[this.currentLevel].items.randomIndex].inView&&!this.levels[this.currentLevel].items.bazooka[this.levels[this.currentLevel].items.randomIndex].active){
										this.levels[this.currentLevel].items.bazooka[this.levels[this.currentLevel].items.randomIndex].Spawn(2,this.levels[this.currentLevel].scrollWidth - this.levels[this.currentLevel].staticScrollWidth);
									};
								};
							};

							/*if(this.levels[this.currentLevel].items.bikesCount > 0 && !g_Player.speedBoost && g_Player.isEvil){
								this.levels[this.currentLevel].items.randomChance = Math.round( Math.random() * (10));
								if(this.levels[this.currentLevel].items.randomChance === 0){
									this.levels[this.currentLevel].items.randomIndex = Math.round(Math.random() * (this.levels[this.currentLevel].items.bikesCount-1));
									if(!this.levels[this.currentLevel].items.bikes[this.levels[this.currentLevel].items.randomIndex].inView&&!this.levels[this.currentLevel].items.bikes[this.levels[this.currentLevel].items.randomIndex].active){
										this.levels[this.currentLevel].items.bikes[this.levels[this.currentLevel].items.randomIndex].Spawn(3);
									};
								};
							};*/


						};



						 ;
								function LadyOfTheNight(_opts){
							this.position = new Vector(_opts&&_opts.x || 0, _opts&&_opts.y || 0);
							this.staticPosition = new Vector(_opts&&_opts.x || 0, _opts&& _opts.y || 0);
							this.size = new Vector(_opts&&_opts.w || 26, _opts&&_opts.h || 46);
							this.srcsize = new Vector(_opts&&_opts.sw || 32, _opts&&_opts.sh || 46);
							this.dest = new Vector( _opts&&_opts.dx || 32,  _opts&&_opts.dy || 128);

							this.inView = false;
							this.currentFrameX = 0;
							this.maxFrameX = 4;
							this.frameDelay = 0;
							this.frameDelayAmount = 8;

							this.isEvil = false;

							this.isFg = _opts.isFg;

						};

						LadyOfTheNight.prototype.Render=function(){
							if(!Arena.spriteSheets['charactergood'] || !Arena.spriteSheets['charactergood'].img || !Arena.spriteSheets['charactergood'].spritesLoaded || !this.inView){return false;}
							this.Animate();
							ctx.drawImage(Arena.spriteSheets['charactergood'].img, this.dest.x*this.currentFrameX, this.dest.y, this.size.x,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						}
						LadyOfTheNight.prototype.Update=function(_offset){
							if(_offset){this.position.x = (this.staticPosition.x + _offset); }
							if(((this.position.x)-g_Level.viewport.x) >= (playWidth) || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight)){this.inView = false; return;}
							this.inView = true;
							this.evilWorld();
						};

						LadyOfTheNight.prototype.Animate=function(){
							if(this.frameDelay++ > this.frameDelayAmount)
							{
								this.frameDelay = 0;
								this.currentFrameX++;
								if(this.currentFrameX >= this.maxFrameX)
								{	
									this.currentFrameX = 0;
								}
							}
						}
						LadyOfTheNight.prototype.evilWorld=function(){}
						LadyOfTheNight.prototype.Restart=function(_override){
							if(_override){
								this.position.x = this.staticPosition.x;
								this.position.y = this.staticPosition.y;
							}
							this.inView = false;
						};
						LadyOfTheNight.prototype.RenderEvil=function(){
							if(!Arena.spriteSheets['charactergood'] || !Arena.spriteSheets['charactergood'].img || !Arena.spriteSheets['charactergood'].spritesLoaded || !this.inView){return false;}
							oCtx.drawImage(Arena.spriteSheets['charactergood'].img, this.dest.x*this.currentFrameX, this.dest.y, this.size.x,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
						};
						LadyOfTheNight.prototype.evilWorld=function(){
							this.isEvil = ((g_Level.evilViewport.x)) < ((this.position.x) - g_Level.viewport.x) ? false : ((this.position.x-g_Level.viewport.x) > playWidth || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight+g_Level.viewport.y)) ? false : true;
						};;
								function Tile(_opts){
							this.type = this.constructor.name;
							this.position = new Vector( _opts&&_opts.x || 0, _opts&& _opts.y || 0);
							this.staticPosition = new Vector(_opts&&_opts.x || 0, _opts&& _opts.y || 0);
							this.size = new Vector( _opts&&_opts.w || 0,  _opts&&_opts.h || 0);
							this.bbox = new Vector( _opts&&_opts.bx ||  _opts&&_opts.w,  _opts&&_opts.by ||  _opts&&_opts.h);
							this.dest = new Vector( _opts&&_opts.dx || 0,  _opts&&_opts.dy || 0);

							this.startCollision =  _opts&&_opts.collision || false;
							this.collision =  _opts&&_opts.collision || false;
							this.platform =  _opts&&_opts.platform || false;
							this.inView = false;
							this.isEvil = false;
							this.dead = false;
							this.layer =  _opts&&_opts.layer || 3;
							this.tileType =  _opts&&_opts.type || Tile.TYPE.tile;
							this.enemylayer = _opts&&_opts.enemylayer || 3;
							this.evilPosition = new Vector(0,0);

							this.isFg = _opts.isFg;

							this.children = [];
							this.particles = [];
						};

						Tile.TYPE = {
							tile:0,
							truck:1,
							suv:2
						};

						Tile.prototype.Restart=function(_override){
							if(_override){
								this.position.x = this.staticPosition.x;
								this.position.y = this.staticPosition.y;
							}

							this.collision = this.startCollision;
							this.dead = false;
							this.inView = false;
							for(var i = 0, len = this.children.length; i < len; i++)this.children[i].Restart(_override);
						};
						Tile.prototype.Update=function(_offset){
							if(_offset){this.position.x = (this.staticPosition.x + _offset); }
							for(var i = 0, len = this.children.length; i < len; i++)this.children[i].Update(_offset);
							
							if(this.dead){this.collision=false;}
							if(((this.position.x)-g_Level.viewport.x) >= (playWidth+Arena.TILESIZE) || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 ){this.inView = false; this.collision = false; return;}
							if((this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight)){this.inView = false; this.collision = this.startCollision; return;}
							if(!this.inView)this.inView = true;
							if(this.collision !== this.startCollision)this.collision = this.startCollision;

							//nothing for now
							this.evilWorld();
							if(this.dead)return false;

						};
						Tile.prototype.Trigger=function(obj, _opts){
							var self = this;
							if(obj.type==='Player'){
								if(_opts&&_opts.direction===Character.DIRECTIONS.RIGHT){
									g_Level.catchPlayer();
								}
							}else
							if(obj.type==='BazookaBullet'){
								if(!g_Level.levels[g_Level.currentLevel].linkTileToExplosion[this.tileType]){ this.Smash(); return true; }

								for(var i=0, len=g_Level.levels[g_Level.currentLevel].linkTileToExplosion[this.tileType].length; i<len; i++){
									g_Level.levels[g_Level.currentLevel].children[g_Level.levels[g_Level.currentLevel].linkTileToExplosion[this.tileType][i]].Smash();
								}
								//this.Smash();
								//do nothing for now.
							}

						};
						Tile.prototype.evilWorld=function(){
							
							this.isEvil = ((g_Level.evilViewport.x)) < ((this.position.x) - g_Level.viewport.x) ? false : ((this.position.x-g_Level.viewport.x) > playWidth || (this.position.x+this.size.x)-g_Level.viewport.x <= 0 || (this.position.y+this.size.y)-g_Level.viewport.y<= 0 || (this.position.y-g_Level.viewport.y >= playHeight+g_Level.viewport.y)) ? false : true;

						};
						Tile.prototype.Die=function(){
							this.collision = false;
							//this.inView = false;
							this.dead = true;
						};

						Tile.prototype.Smash=function(){
							g_Level.shake=true;
							if(this.children[0]){ this.children[0].Spawn({x: this.position.x, y:this.position.y}); sounds.explosion.play(); }
							for(var i=0,len=this.particles.length; i < len; i++)this.particles[i].Alive({x:(this.position.x+(this.size.x/2)), y:(this.position.y+(this.size.y/2))});
							this.Die();
						};

						Tile.prototype.Render=function(){

							ctx.globalCompositeOperation = "lighter";
							for(var i = 0, len = this.children.length; i < len; i++)this.children[i].Render();
							ctx.globalCompositeOperation = "source-over";

							if( !Arena.spriteSheets['eviltiles'].img || !Arena.spriteSheets['goodtiles'].img || !Arena.spriteSheets['eviltiles'].spritesLoaded || !Arena.spriteSheets['goodtiles'].spritesLoaded || this.dead || this.tile===null || !this.inView)return;
							
							if(debug&&this.collision){
								ctx.strokeStyle='#0000ff';
								ctx.strokeRect(this.position.x-g_Level.viewport.x,this.position.y-g_Level.viewport.y,this.size.x,this.size.y);
							}

							//if(!this.isEvil){ ctx.drawImage(Arena.spriteSheets['goodtiles'].img, this.dest.x, this.dest.y, this.size.x,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y); return;}
							ctx.drawImage(Arena.spriteSheets['goodtiles'].img, this.dest.x, this.dest.y, this.size.x,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.size.x,this.size.y);
							return;


							/*this.evilPosition.x = (((g_Level.evilViewport.x)) - ((this.position.x) - g_Level.viewport.x));
							this.evilPosition.y = this.size.y;

							if(this.evilPosition.x >= this.size.x){this.evilPosition.x = this.size.x;}
							
							var imageWidth = (this.size.x-this.evilPosition.x);
							if(imageWidth)ctx.drawImage(Arena.spriteSheets['goodtiles'].img,(this.dest.x)+this.evilPosition.x,this.dest.y,imageWidth,this.size.y, ((this.position.x+this.evilPosition.x) - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, imageWidth, this.size.y);
							if(this.evilPosition.x)ctx.drawImage(Arena.spriteSheets['eviltiles'].img, (this.dest.x) , (this.dest.y) , this.evilPosition.x ,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.evilPosition.x,this.size.y);*/
						};

						Tile.prototype.RenderEvil=function(){
							if(!this.isEvil || this.dead || !this.inView)return false;
							this.evilPosition.x = (((g_Level.evilViewport.x)) - ((this.position.x) - g_Level.viewport.x));
							this.evilPosition.y = this.size.y;

							if(this.evilPosition.x >= this.size.x){this.evilPosition.x = this.size.x;}
							
							var imageWidth = (this.size.x-this.evilPosition.x);
							//if(imageWidth)ctx.drawImage(Arena.spriteSheets['goodtiles'].img,(this.dest.x)+this.evilPosition.x,this.dest.y,imageWidth,this.size.y, ((this.position.x+this.evilPosition.x) - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, imageWidth, this.size.y);
							if(this.evilPosition.x)oCtx.drawImage(Arena.spriteSheets['eviltiles'].img, (this.dest.x) , (this.dest.y) , this.evilPosition.x ,this.size.y, (this.position.x - g_Level.viewport.x - g_Level.shakeViewport.x), this.position.y - g_Level.viewport.y - g_Level.shakeViewport.y, this.evilPosition.x,this.size.y);
						};

						Tile.prototype.createParticle=function(){
							for(var j = 0; j < 3; j++){
								for(var i = 0; i < 8; i++){
									var _angle = (Math.random() * (360)) >> 0;
									this.children.push(new ExplosionParticle({
										id:Math.random(),
										x:-1000,
										y:-1000,
										w:20,
										h:20,
										sw:32,
										sh:32,
										velocity:{x:(Math.random()*(5-2)+2),y:((3))},
										angle:_angle,
										dx:(i*32),
										dy:160,
										delay:0//i === 0 ? 0 : Math.round(i/8)
									}));
									this.particles.push(this.children[this.children.length-1]);
								};
							};
						};








						 ;
								/*
						========
						GLOBAL
						========
						*/

						var g_Player = null;
						var g_Level = null;
						var g_Utilities = null;
						var g_Enemies = [];
						var g_Menus = {};
						var g_OverlayMenus = {};
						var g_MobileMenu = {};
						var g_Snow = [];
						var g_QuadTree = null;
						var g_LevelMask = null;

						var game = {
							_render:null,
							/*STATES*/
							STATES:{
								PLAY:0,
								MENU:1,
								END:2,
								LOADER:3
							},
							gameState:null,
							previousMenu:null,
							currentMenu:null,
							currentOverlay:null,
							previousMobileMenu:null,
							currentMobileMenu:null,

							/*loaderColors*/
							lColor1:'#f3f3f3',
							lColor2:'#e6e6e6',
							lColor3:'#ff7c7c',
							lColor4:'#f25454',

							loadGameUpdate:function(){
								if(Arena.CURRENTASSETS >= Arena.MAXASSETS){
									ctx.clearRect(0,0,playWidth,playHeight); // remove all assets ready for the game!
									game.gameState = game.STATES.MENU;
									game.login();
								};
							},
							login:function(){

								//TODO:// PIOTR JSON ENCODE THE RESPONSE IN THE API CALLS!
								//FOR NOW MAKE ThE usER GO TO THE MAIN SCREEN
								g_Menus['home'].On();
								if(isMobile())game.currentMobileMenu.On();
								return true;

								if(isMobile())game.currentMobileMenu.On();
								
								//check to see if the user has logged in. if false, then take them to the login screen else take them to the main menu.
								if(window.localStorage){
									if(window.localStorage.getItem('token')){ g_Menus['home'].On(); return true; }
									g_Menus['login'].On();
								}else{
									g_Menus['home'].On();
								}

								
							},
							loadGameRender:function(){

								
								var amount = (Arena.CURRENTASSETS/Arena.MAXASSETS);
								amount *= 240;

								/*bottombar!*/		
								ctx.fillStyle = game.lColor1;
								ctx.fillRect(((playWidth/2)-120),((playHeight/2)-16),240,16);
								ctx.fillStyle = game.lColor2;
								ctx.fillRect(((playWidth/2)-120),((playHeight/2)),240,16);

								/*overlay bar */

								ctx.fillStyle = game.lColor3;
								ctx.fillRect(((playWidth/2)-120),((playHeight/2)-16),amount,16);
								ctx.fillStyle = game.lColor4;
								ctx.fillRect(((playWidth/2)-120),((playHeight/2)),amount,16);

							},
							initialise:function(){
								game.bindEvents();
							},
							bindEvents:function(){
								window.addEventListener("load", game.start, false);
								user.events();
							},
							restart:function(){
								g_Level.Restart();
								g_Player.Restart();
								for(var i = 0, len = g_Enemies.length; i < len; i++)g_Enemies[i].Restart();
								g_Utilities.Restart();
								g_Utilities.then = Date.now(); // GET THE BALL ROLLING!!! BAAYBEEE
								cancelAnimationFrame(game._render);
								game.Loop();
							},
							start:function(){
								g_Level = new Arena({vx:0,vy:0});
								game.buildMenus();
							},
							startElements:function(){
								g_Player = new Player();
								g_Utilities = new Utilities();
								
								for(var i = 0; i < 50; i++){g_Enemies.push(Character.RandomEnemy());}
								
								g_Snow.push(new Snow({dx:0, dy:0, delay:0.20}));

								g_QuadTree = new QuadTree({x:0,y:0,width:playWidth,height:playHeight},false,7);//new QuadTree({x:0,y:0,width:playWidth,height:playHeight});

								g_LevelMask = new Mask();


								game.Begin();
							},
							Begin:function(){
								g_Utilities.then = Date.now(); // GET THE BALL ROLLING!!! BAAYBEEE
								game.Loop();
							},
							Loop:function(){

								g_Utilities.now = Date.now();
								g_Utilities.delta = (g_Utilities.now - g_Utilities.then)/1000;
								g_Utilities.then = g_Utilities.now;

								if (g_Utilities.delta>0.25)
									g_Utilities.delta = 0.25;

								g_Utilities.accumulator += g_Utilities.delta;
								
								while( g_Utilities.accumulator >= g_Utilities.fixedDelta){
									game.Update();
									g_Utilities.accumulator -= g_Utilities.fixedDelta;
									
								};


								
								game.Render();
							
								//Make the loop go around again ASAP
								game._render = requestAnimationFrame(game.Loop);
							},
							Update:function(){
								switch(game.gameState){
									case game.STATES.PLAY:
										g_QuadTree.Update();
										g_Player.Update();
										for(var i = 0, len = g_Enemies.length; i < len; i++)g_Enemies[i].Update();
										g_Level.Update();
										g_Utilities.Update();
									break;

									case game.STATES.MENU:
										g_Utilities.then = Date.now(); // keep resetting this as we dont want anything to be too large!
									break;

									case game.STATES.END:
									break;

									case game.STATES.LOADER:
										game.loadGameUpdate();
									break;
								};
							},
							Render:function(){
								switch(game.gameState){
									case game.STATES.PLAY:
										g_Level.Render();
										if(game.currentOverlay!==null)game.currentOverlay.Render();
									break;

									case game.STATES.MENU:
										/*ctx.clearRect(0,0,playWidth,playHeight);
										game.currentMenu.Render();*/
									break;

									case game.STATES.END:
									break;

									case game.STATES.LOADER:
										game.loadGameRender();
									break;
								};
							},
							buildMenus:function(){
									
								g_OverlayMenus['desktopoverlay'] = new DesktopOverlayMenu({
									x:0,y:0,w:playWidth,h:playHeight,active:false,
									buttons:[
										new HealthBar({x:((playWidth/2)-(165/2)),y:6,w:165,h:22,dx:315,dy:0,dx2:262,dy2:40,dx3:262,dy3:24,bx:((playWidth/2)-(135/2)),by:9,bw:135,bh:16, type:'image',bgAlpha:1}), // healthbar
										new CounterElement({x:0,y:6,w:74,h:22,dx:0,dy:88, type:'image',bgAlpha:1,incElemOBJAttr:'score', textPosition:{x:25, y:17}}), // COINS
										new CounterElement({x:(playWidth-(74)),y:6,w:74,h:22,dx:239,dy:88, type:'image',bgAlpha:1,incElemOBJAttr:'distance',textPosition:{x:20, y:17}}), // distance
									]
								});g_OverlayMenus['desktopoverlay'].Initialise();
								game.currentOverlay = g_OverlayMenus['desktopoverlay'];
								game.currentOverlay.active = true;


								g_Menus['home'] = new MainMenu({name:'home', queryID:'article.menu section.home', parentQueryID:'article.menu'});
								g_Menus['ingame-pause'] = new MainMenu({name:'ingame-pause', queryID:'article.menu section.ingame-pause', parentQueryID:'article.menu'});
								g_Menus['settings'] = new MainMenu({name:'settings', queryID:'article.menu section.settings', parentQueryID:'article.menu'});
								g_Menus['leaderboards'] = new MainMenu({name:'leaderboards', queryID:'article.menu section.leaderboards', parentQueryID:'article.menu'});
								g_Menus['about'] = new MainMenu({name:'about', queryID:'article.menu section.about', parentQueryID:'article.menu'});
								g_Menus['login'] = new MainMenu({name:'login', queryID:'article.menu section.login', parentQueryID:'article.menu'});
								g_Menus['register'] = new MainMenu({name:'register', queryID:'article.menu section.register', parentQueryID:'article.menu'});
								
								if(isMobile()){
									g_MobileMenu['mobile'] = new MobileMenu({name:'mobile', queryID:'article.overlays section.mobile', parentQueryID:'article.overlays'});
									game.currentMobileMenu = g_MobileMenu['mobile'];
									MobileMenu.Actions('article.overlays');
								};

								MainMenu.Actions('article.menu');
							}
						};

						game.gameState = game.STATES.LOADER;
						game.initialise();

						window.scrollTo(0,1);
					</script>
				</div>
				<div class="static"></div>
				<img class="front" src="santa_tv.png"/>
			</div>
		</div>
		<div id="qr">
			<img class="back"src="qr_frame.png"/>
			<div id="qrcode" class="front"></div>
			<div>http://goo.gl/eKpLHO</div>
		</div>
	</body>
</html>